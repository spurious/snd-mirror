<html>
<head>
<title>Snd Customization and Extension</title>
<style type="text/css">
<!-- 
	EM.red {color:red; font-style:normal}
        EM.error {color:chocolate; font-style:normal}
        EM.narg {color:chocolate; font-style:italic}
        EM.targ {color:darkgreen; font-style:italic}
        EM.typing {color:maroon; font-style: normal}
        EM.listener {color:darkblue; font-style: normal}
	H1 {text-align: center}
	UL {list-style-type: none}
-->
</style>
</head>
<body bgcolor=white>

<a name="extsndcontents"></a>
<h1>Snd Customization and Extension</h1>

<center><small><a href="snd.html#overview">snd.html</a>    <a href="grfsnd.html#grfsndcontents">grfsnd.html</a>    <a href="clm.html#introduction">clm.html</a>    <a href="sndlib.html#introduction">sndlib.html</a></small></center>

<ul>
<li><a href="#lisplistener">Introduction</a>
<li><a href="#etc">Snd Programming</a>
  <ul>
  <li><a href="#appearance">Customizing Snd's appearance</a>
    <ul>
    <li><a href="#colors">Colors</a>
    <li><a href="#fonts">Fonts</a>
    </ul>
  <li><a href="#behavior">Customizing Snd's behavior</a>
    <ul>
    <li><a href="#sndglobalvars">Global variables</a>
    <li><a href="#sndhooks">Hooks</a>
    </ul>
  <li><a href="#sndobjects">Snd's objects</a>
    <ul>
    <li><a href="#Vcts">Vcts</a>
    <li><a href="#samplereaders">Sample-readers</a>
    <li><a href="#sndsndlib">Sound-data and Sndlib</a>
    <li><a href="#sndmarks">Marks</a>
    <li><a href="#sndmixes">Mixes</a>
    <li><a href="#sndregions">Regions</a>
    <li><a href="#sndsounds">Sounds and channels</a>
      <ul><li><a href="#customcontrols">the control panel</a></li></ul>
    <li><a href="#editlists">Edit Lists</a>
    <li><a href="#scanning">Scanning Data</a>
    <li><a href="#sndtransforms">Transforms</a>
    <li><a href="#snddialogs">Dialogs and Menus</a>
    <li><a href="#snderrors">Errors</a>
    <li><a href="#sndconstants">Constants</a>
    <li><a href="#sndmisc">Miscellaneous functions</a>
    </ul>
  <li><a href="#sndexamples">Examples</a>
  <li><a href="grfsnd.html#grfsndcontents">Customization Part 2</a>
  </ul>
</ul>

<h2>Introduction</h2>
<a name="lisplistener"></a>

<p>Snd is a highly customizable, extensible program.
The syntax used is Scheme (a form of lisp) as implemented by the Gnu Guile library.
I've tried to bring out to lisp nearly every portion
of Snd, both the signal-processing functions, and
much of the user interface.  You can, for example,
add your own menu choices, editing operations, 
or graphing alternatives.
Nearly everything in Snd can be set in an initialization
file, loaded at any time from a file of scheme code or a <a href="snd.html#savedstate">saved state</a> file,
specified via inter-process communciation or from stdin
from any other program (CLM and Emacs in particular),
imbedded in a keyboard macro, or accessed in the
lisp listener.  The easiest way to get acquainted
with this aspect of Snd is to open the listener
(via the View:Open listener menu option), and type
experiments in its window.  Its prompt is "&gt;". So,
say we've opened the listener, and (my typing is 
in <em class=typing>this font</em> and Snd's responses
are in <em class=listener>this font</em>).
</p>
<pre>
&gt;<em class=typing>(+ 1 2)</em>
<em class=listener>3</em>
</pre>
<p><small>If the listener is active, and some sound
is selected, any characters typed while in the sound
graph which it can't handle are passed to the
listener; to exit the listener without using the
mouse, type C-g.</small></p>

<h2><a name="etc">Snd Programming</a></h2>

<p>Snd is organized as a list of sounds, each with a list of channels,
each channel containing lists of edits, marks, mixes, etc.
There are other objects such as colors, vcts (an optimization
of vectors), and regions; the currently active region is
called the selection.  I originally presented all the
various functions and variables in an enormous alphabetical
list, but that finally became unmanageable.  In the following
sections, each of the basic entities is treated in a separate
section with cross-references where needed.  The <a href="grfsnd.html#extsndindex">index</a>
provides alphabetical entry.</p>

<p>There are many examples in examp.scm and snd-test.scm.  In addition,
various extensions to Snd can be found in:
</p>
<pre>
bell.scm          the fm-bell from CLM
effects.scm       an Effects menu based on examp.scm
env.scm           various envelope functions from CLM
fmv.scm           the fm-violin tied to real-time gtk graphics
glfft.scm         OpenGL for spectra (needs work)
goopsnd.scm       first look at Goops (Guile Object System) for Snd
index.scm         snd-help locators
loop.scm          some Common Lisp syntax in Scheme
marks.scm         functions related to marks
mix.scm           functions related to mixes and tracks
moog.scm          Moog filter (from CLM)
pqwvox.scm        phase-quadrature waveshaping (from CLM)
pvoc.scm          phase-vocoder examples
rgb.scm           color definitions
snd-gtk.scm       various Guile-Gtk examples
v.scm             fm-violin (from CLM)
zip.scm           the zipper (a cross-fader, sort of) (from CLM)
</pre>
<hr>

<h3><a name="appearance">Customizing Snd's appearance</a></h3>

<p>Snd's overall appearance is controlled first by the startup <a href="grfsnd.html#sndswitches">switches</a> that
choose the outermost widget; normally this is a paned window with a sound
in each pane; -separate puts each
sound in a separate window, and -notebook
puts each sound on a separate page of a notebook widget.  Similarly -horizontal
and -vertical determine which way the outer panes are layed out. 
As panes (sounds) come and go, Snd's overall size may change (this is
partly determined by the window manager, but is to some extent also
up to Snd); many people find this distracting -- they would rather the
overall window size try to stay the same.  The Snd variable associated
with this is "auto-resize"; it can be accessed as follows (we're typing
to the listener here, as described above):</p>

<pre>
&gt;<em class=typing>(auto-resize)</em>
<em class=listener>#t</em>
&gt;<em class=typing>(set! (auto-resize) #f)</em>
<em class=listener>#f</em>
</pre>

<p>As this illustrates, 
variables in Snd are accessed as though each were a function, and set using set!.  auto-resize's current
value is accessed above via <code>(auto-resize)</code>, and set to a
new value via <code>(set! (auto-resize) #f)</code>. #t is Scheme for "true"
(often 1 in C, t in Lisp), #f is "false" (0 in C, nil in Lisp).
A statement like <code>(set! (auto-resize) #f)</code> can be placed in your ~/.snd initialization file
to make it the default setting for your version of Snd, or placed
in a separate file of Scheme code and loaded at any time via the load
function.  </p>

<p>In the sections below, the variable or function name is followed by
either its default value or the function arguments, then some brief
description of what it does.  So,
</p>
<pre>
  basic-color           ivory2          main Snd color.
</pre>
<p>means there's a thing called basic-color (and a way to set it via  "(set! (basic-color) ...)"),
that its default value is ivory2 (see rgb.scm for a definition of this color), and that
it is the main Snd color.</p>

<h4><a name="colors">Colors</a></h4>

<p>A color in Snd is an object with three fields representing the
rgb (red green blue) settings as numbers between 0.0 and 1.0.  A color
object is created via make-color:</p>
<pre>
&gt;<em class=typing>(define blue (make-color 0 0 1))</em>
</pre>
<p>This declares the Scheme variable "blue" and gives it the value
of the color whose rgb components include only blue in full force.
The X11 color names are defined in rgb.scm. Now, in Snd, the basic
color is known as "basic-color" (another Scheme variable); we can
set it:</p>
<pre>
&gt;<em class=typing>(set! (basic-color) blue)</em>
</pre>

<p>The color variables
are:</p>
<pre>
  <a name="basiccolor">basic-color</a>           ivory2          main Snd color.
  <a name="cursorcolor">cursor-color</a>          red             cursor color.
  <a name="datacolor">data-color</a>            black           color of data in unselected graph.	
  enved-waveform-color  blue            color of waveform displayed in envelope editor.
  <a name="filterwaveformcolor">filter-waveform-color</a> blue    color of control panel filter waveform.
  <a name="graphcolor">graph-color</a>           white           background color of unselected graph.
  <a name="highlightcolor">highlight-color</a>       ivory1          highlighting color.
  listener-color        aliceblue       background color of lisp listener.
  mark-color            red             color of mark indicator.
  mix-color             lightgreen      color of mixer consoles
  mix-focus-color       yellow2         color of selected mix.
  mix-waveform-color    darkgray        color of mix waveform.
  <a name="positioncolor">position-color</a>        ivory3          position slider color
  <a name="pushedbuttoncolor">pushed-button-color</a>   lightsteelblue1 color of pushed button.
  sash-color            lightgreen      color of paned window sashes.
  <a name="selecteddatacolor">selected-data-color</a>   black           color of data in currently selected graph.
  <a name="selectedgraphcolor">selected-graph-color</a>  white           background color of currently selected graph.
  <a name="selectioncolor">selection-color</a>       lightsteelblue1 color of selected portion of graph.
  <a name="textfocuscolor">text-focus-color</a>      white           color of text field when it has focus.
  <a name="zoomcolor">zoom-color</a>            ivory4          zoom slider color.
</pre>
<p>In addition, the various transforms can be displayed using colormaps.  The following
variables and functions control this:</p>
<pre>
  <a name="colorcutoff">color-cutoff</a>          0.003   In spectra, sets the lowest data value that will be colored.
  <a name="sndcolordialog">color-dialog</a>          ()      Fire up the Color dialog (to choose a colormap etc).
  <a name="colorinverted">color-inverted</a>        #t      The 'invert' button in the <a href="snd.html#colorbrowser">color</a> dialog, negated (hunh?!).
  <a name="colorscale">color-scale</a>           0.5     The darkness setting in the <a href="snd.html#colorbrowser">color</a> dialog, divided by 100.
  <a name="colormap">colormap</a>              0       Colormap choice for various displays (see the Color Editor).
<small>
            This should be an integer between -1 and 15.  The maps (from 0 to 15) are: 
            gray, hsv, hot, cool, bone, copper, pink, jet, prism, autumn, winter, 
            spring, summer, colorcube, flag, and lines.  -1 means black and white.
</small>
  <a name="loadcolormap">load-colormap</a>     (colors)      use colors in <i>colors</i> (a vector) as current colormap.
<small>
            This is still kludgey, but the following shows how to use it:

               (load "rgb.scm")
               (define hi (make-vector 512)) ;use 64 if not using big colormaps
               (do ((i 0 (+ i 4))) ((>= i 512)) 
                 (vector-set! hi i red) (vector-set! hi (+ i 1) blue) 
                 (vector-set! hi (+ i 2) green) (vector-set! hi (+ i 3) black))
               (<em class=red>load-colormap</em> hi)
</small>
</pre>
<p>The color object handlers are:</p>
<pre>
  <a name="colorp">color?</a>            (obj)         #t if <i>obj</i> is a color object (see <a href="#makecolor">make-color</a>).
  <a name="color3list">color-&gt;list</a>       (obj)         return list (r g b) of color components.
  <a name="makecolor">make-color</a>        (r g b)       return a color value using the red/green/blue values
</pre>
<p><small>(British spelling enthusiasts can use "colour" throughout Snd by building it with the CFLAG
 -DSTR_OR=\"our\").</small>
</p>
<hr>


<h4><a name="fonts">Fonts</a></h4>

<p>Fonts in Snd are strings containing a description of the
desired font.  These can be the abbreviated forms such as
"8x14" or a full X font name such as "-misc-fixed-bold-r-normal--*-140-*-*-c-*-iso8859-1".
The font variables are:
</p>
<pre>
  <a name="axislabelfont">axis-label-font</a>       used in axis labels
  <a name="axisnumbersfont">axis-numbers-font</a>     used in axis tick numbers
  <a name="boldbuttonfont">bold-button-font</a>      used by various buttons and labels
  <a name="buttonfont">button-font</a>           used by various buttons and labels
  help-text-font        help dialog text font
  listener-font         listener font
  <a name="tinyfont">tiny-font</a>             smallest font used
</pre>
<hr>


<h3><a name="behavior">Customizing Snd's behavior</a></h3>

<p>Most of Snd's behavior can be customized.  For example,
when a sound is saved, some people want to be warned if
a pre-existing sound is about to be destroyed; others (Snd's
author included) grumble "just do it".  There are two ways
this kind of situation is handled in Snd; variables and hooks.
A hook is a list of "callbacks" invoked whenever the associated
event happens.  When Snd exits, for example, any functions found
on the exit-hook list are evaluated; if any of them returns #t,
Snd does not exit.</p>
<pre>
(define unsaved-edits?
  (lambda (ind)
    (and (&lt; ind (max-sounds))
	 (or (and (sound? ind)
		  (&gt; (car (edits ind)) 0)
		  (report-in-minibuffer "there are unsaved edits")
		  #t)
	     (unsaved-edits? (+ ind 1))))))

(add-hook! exit-hook (lambda () (unsaved-edits? 0)))
</pre>
<p>Now when Snd is told to exit, it checks exit-hook, runs
unsaved-edits?, and if the latter returns #t, if prints
a worried message in the minibuffer, and refuses to
exit.  Similar hooks customize actions such as closing
a sound (close-hook), clicking a mark (mark-click-hook),
pressing a key (key-press-hook), and so on.  Slightly
special are the hooks output-comment-hook and output-name-hook;
these refer to the default file name and comment displayed
when you save a sound via the "save" dialog.</p>

<h4><a name="sndglobalvars">Global variables</a></h4>

<p>The main variables affecting Snd's overall behavior are:</p>

<pre>
  <a name="askbeforeoverwrite">ask-before-overwrite</a>  #f      (Save-as): ask before <a href="snd.html#overwrite">overwriting</a> an existing file
  <a name="autoupdate">auto-update</a>           #f      should Snd <a href="snd.html#updatefile">update</a> a file automatically.
  <a name="audiooutputdevice">audio-output-device</a>   <i>sndlib-default-device</i> Audio output device (for the play button)
  <a name="audiostatefile">audio-state-file</a>      ".snd-mixer"  Name of file in which current audio hardware settings are saved.
  <a name="autoresize">auto-resize</a>           #t      should Snd window resize upon open/close (see <a href="grfsnd.html#xautoresize">AutoResize</a>)
  <a name="channelstyle">channel-style</a>         <i>channels-separate</i>
                                The default state of the '<a href="snd.html#unitebutton">unite</a>' button in multi-channel files.  
                                  Other values are <i>channels-combined</i> and <i>channels-superimposed</i>.  
  <a name="corruptiontime">corruption-time</a>       60      Time (seconds) between background checks for changed file on disk 
                                  (see <a href="#autoupdate">auto-update</a>). If less than 0.0, background process is turned off.
  <a name="dacfolding">dac-folding</a>           #t      channels folded upon dac output if not enough dac channels are available.
  <a name="dacsize">dac-size</a>              256     Audio output buffer size (not always meaningful).
  <a name="dataclipped">data-clipped</a>          #f      If #t, output values are clipped to fit the current sndlib sample
                                  representation's notion of -1.0 to just less than 1.0.  The default
                                  causes wrap-around which makes the out-of-range values very obvious.
  <a name="defaultoutputchans">default-output-chans</a>  -1      The default number of channels when a new or temporary file is created, 
                                  or a save dialog is opened.
  <a name="defaultoutputformat">default-output-format</a> -1      The default data format when a new or temporary file is created, 
                                  or a save dialog is opened. -1 here means try to use the current 
                                  sound's data format (or no default).
  <a name="defaultoutputsrate">default-output-srate</a>  -1      The default srate when a new or temporary file is created, 
                                  or a save dialog is opened.
  <a name="defaultoutputtype">default-output-type</a>   -1      The default header type when a new or temporary file is created, 
                                  or a save dialog is opened. -1 means use the current sound's type.
  <a name="epsfile">eps-file</a>              "snd.eps"  Name of the Postscript file produced by the <a href="snd.html#printfile">File Print</a> option.
                                See also the <a href="grfsnd.html#epsresource">epsFile</a> resource.
  <a name="fitdataonopen">fit-data-on-open</a>      #f      If #t, the initial time-domain display of a sound shows
                                its entire duration, with the Y-axis set to show its maxamp.
  <a name="graphcursor">graph-cursor</a>          XC_crosshair (34) cursor displayed following mouse in graph
<small>
        The X cursors are declared in /usr/X11R6/include/X11/cursorfont.h or some such file.
</small>
  <a name="initialx0">initial-x0</a>            0.0     Initial time domain window left bound (seconds).
  <a name="initialx1">initial-x1</a>            0.1     Same, but on the right.
  <a name="initialy0">initial-y0</a>           -1.0     Initial window y axis minimum.
  <a name="initialy1">initial-y1</a>            1.0     Same, but maximum.
  <a name="movies">movies</a>                #t      If #t, the mix graphs are updated constantly as the 
                                  mouse drags the mix console.
  <a name="normalizeonopen">normalize-on-open</a>     #t      When a new sound is added to the Snd window, the resultant
                                  set of graphs can start to dangle off the bottom or end of the screen.
                                  If <i>normalize-on-open</i> is #t, Snd tries to do something more reasonable.
  <a name="prefixarg">prefix-arg</a>            0       This is the keyboard <a href="snd.html#kcu">C-u</a> style argument (named current-prefix-arg in Emacs).
  <a name="rawchans">raw-chans</a>             1       The "raw-" variables refer to sound data interpretation choices made
                                  when a sound is opened that appears to be headerless.  
                                  <i>raw-chans</i> sets the default number of channels.
  <a name="rawformat">raw-format</a>            <i>mus-bshort</i>
                                The default data format in a headerless sound.  Other possibilities
                                  are given <a href="#snd16linear">above</a>, or you can use the <a href="sndlib.html">Sndlib</a> macros directly.
  <a name="rawsrate">raw-srate</a>             44100   The default headerless sound sampling rate.
  <a name="savedir">save-dir</a>              nil     Name of directory for saved-state files.  
<small>
                                  If nil, all saved-state is placed (as text) in the saved-state.scm
                                  file.  If you've edited a file, this can be unwieldy.  By setting
                                  save-dir, Snd instead places the necessary intermediate files in
                                  save-dir, with the file names in the saved-state file.  The assumption
                                  here is that you won't mess with the save-dir files until you no
                                  longer want to restart that version of Snd.  (set! (save-dir) "/tmp").
</small>
  <a name="savestateonexit">save-state-on-exit</a>    #f      If #t, Snd saves its current state in <a href="#lsavestatefile">save-state-file</a>.
  <a name="lsavestatefile">save-state-file</a>       "saved-snd.scm" The default <a href="snd.html#savedstate">saved state</a> file name.
  <a name="showindices">show-indices</a>          #f      If #t, each sound's name is preceded by its index.
  <a name="lshowselectiontransform">show-selection-transform</a> #f   If #t, display the transform of the current active selection, if any.
  <a name="showusagestats">show-usage-stats</a>      #f      If #t, show approximate memory and disk space usage of current edit trees.
  <a name="sincwidth">sinc-width</a>            10      Width (in samples) of the sampling rate conversion sinc interpolation.
<small>
                                  The higher this number, the better the src low-pass filter, but the slower
                                  src runs.  If you use too low a setting, you can sometimes hear high 
                                  frequency "whistles" leaking through. To hear these on purpose, make 
                                  a sine wave at (say) 55 Hz, then (src-sound '(0 3 1 1)) with sinc-width at 4.
</small>
  <a name="tempdir">temp-dir</a>              nil     Name of directory for temporary files.  nil usually means "/var/tmp".
  <a name="sndtempfilenames">temp-filenames</a>    (data)        return vector of temp file names (see <a href="grfsnd.html#programs">external programs</a>).
  <a name="trapsegfault">trap-segfault</a>         #t      If #t, try to catch segfaults and continue anyway.
  <a name="userawdefaults">use-raw-defaults</a>      #f      If #t, the "raw-" variables' values are used automatically
                                  when a headerless file is encountered.  If #f, Snd fires up the 
                                  raw file dialog to find out how to interpret the data.
  <a name="usesincinterp">use-sinc-interp</a>       #t      If #t, use high quality src, rather linear interpolation.
<small>
                                  This can significantly increase the computational burden on the
                                  computer; if you're trying to play 8 channel 44Khz sounds on an older
                                  machine, It may help to set use-sinc-interp to #f.  In fact, if you're
                                  running a machine in the 100 MHz range, even stereo 44.1kHz can be a
                                  problem -- if the sound has clicks or seems horribly distorted when
                                  the "speed" control is not at 1.0, try setting this variable to #f.
</small>
  <a name="windowheight">window-height</a>         0       The current Snd window height in pixels.
  <a name="windowwidth">window-width</a>          0       The current Snd window width in pixels.
  <a name="windowx">window-x</a>             -1       The current Snd window left side in pixels.
  <a name="windowy">window-y</a>             -1       The current Snd window upper side in pixels (X numbering starts 
                                  at 0 at the top).
  <a name="zoomfocusstyle">zoom-focus-style</a>      <i>focus-active</i>
                                This determines what a zoom action focuses (centers) on.  See <a href="snd.html#zoomoption">Zoom options</a>.
</pre>
<hr>


<h4><a name="sndhooks">Hooks</a></h4>

<p>When some user-interface action takes place, some code is called that responds to that action;
these functions are sometimes called callbacks; in Guile the variable that holds a list of such
callbacks is known as a hook.  
A hook provides
a way to customize user-interface
actions.  
It is either a list of functions or #f.  The Guile function add-hook! adds a function to a hook's
list, remove-hook! removes a function, and reset-hook! clears out the list.
For example, the hook that is checked when you click the sound's name in the minibuffer is
name-click-hook.  We can cause that action to print "hi" in the listener by:</p>
<pre>
&gt;<em class=typing>(add-hook! name-click-hook (lambda (snd) (snd-print "hi") #t))</em>
</pre>
<p>
If there is more than one function attached to a hook, some of the hooks
'or' the functions together (marked <b>or</b> below); that is they
run through the list of functions, and if any function returns #t, the
hook immediately returns #t (ignoring the remaining functions), whereas in the other
cases, the result returned by the hook is the result of the last function in the list.
In the list below the arguments after the hook name refer to the functions invoked by
the hook.  
</p>
<pre>
  <a name="aftergraphhook">after-graph-hook</a> (snd chn)          called after a graph is updated or redisplayed.
  <a name="afteropenhook">after-open-hook</a> (snd)               called just before the new file's window is displayed.
<small>
                                      This provides a way to set various sound-specific defaults.  
                                      For example, the following causes Snd to default to locally 
                                      sync'd channels (that is, each sound's channels are sync'd 
                                      together but are independent of any other sound), united channels, 
                                      and filled graphs:

                                       (add-hook! after-open-hook 
                                         (lambda (snd)
                                           (if (> (channels snd) 1)
                                               (begin
                                                 (set! (syncing) (1+ snd) snd) ; 0 = #f
                                                 (set! (uniting) channels-combined snd)))
                                           (set! (graph-style) graph-filled)))
</small>
  <a name="closehook">close-hook</a> (snd)                    called each time a file is closed (before the close). (<b>or</b>)
                                        If it returns #t, the file is not closed.
  <a name="duringopenhook">during-open-hook</a> (fd name reason)   called after file is opened, but before data has been read.
<small>
                                      This provides an opportunity to set sndlib prescaling values:

                                       (add-hook! during-open-hook
                                         (lambda (fd name reason)
                                           (if (= (mus-sound-header-type name) mus-raw)
                                               (mus-file-set-prescaler fd 500.0))))
</small>
  <a name="exithook">exit-hook</a> ()                        called upon exit. (<b>or</b>)
                                        If it returns #t, Snd does not exit.  This can be used to check 
                                        for unsaved edits, or to perform cleanup activities.
  <a name="ffthook">fft-hook</a> (snd chn scaler)           called just after an FFT (or spectrum) is calculated.
  <a name="graphhook">graph-hook</a> (snd chn y0 y1)          called each time a graph is updated or redisplayed.
                                        If it returns #t, the display is not updated.
  <a name="justsoundshook">just-sounds-hook</a> (filename)         called on each file (after the sound file extension check) if the
                                        just-sounds button is set. Return #f to filter out <i>filename</i>.
<small>
                                      (add-hook! just-sounds-hook 
                                        (lambda (name) ;display only stereo files in file selection dialog
                                          (and (not (= (mus-sound-header-type name) mus-raw)) ;any unrecognized file is considered "raw"
                                               (= (mus-sound-chans name) 2))))
</small>
                                        This currently only works in Motif; the Gtk file selection dialogs 
                                        don't provide a way to specialize the directory read.
  <a name="keypresshook">key-press-hook</a> (snd chn key state)  called upon key press while mouse is in lisp graph. (<b>or</b>)
                                        If it returns #t, the key press is not passed to the main handler.
                                        <i>state</i> refers to the control, meta, and shift keys.
  <a name="markclickhook">mark-click-hook</a> (id)                called when a mark is clicked, return #t to squelch message.
<small>
                                      (add-hook! mark-click-hook 
                                        (lambda (n) 
                                           (help-dialog "Mark Help" (number-&gt;string (mark-sample n))) 
                                           #t))
</small>
  <a name="mixampchangedhook">mix-amp-changed-hook</a> (id)           called when mix console amp changes via mouse (id = mix id).
                                        If #t, the actual remix is the hook's responsibility.
  <a name="mixconsolestatechangedhook">mix-console-state-changed-hook</a> (id) called when mix console state changes via mouse (id = mix id).
  <a name="mixpositionchangedhook">mix-position-changed-hook</a> (id samps)called when mix console moves via mouse (id = mix id, 
                                        samps = samps moved). (<b>progn</b>) If #t, the actual remix is the 
                                        hook's responsibility.
  <a name="mixspeedchangedhook">mix-speed-changed-hook</a> (id)         called when mix console speed changes via mouse (id = mix id).
                                        If #t, the actual remix is the hook's responsibility.
  <a name="mousedraghook">mouse-drag-hook</a>    (snd chn button state x y) 
                                        called upon mouse motion (with button pressed) within lisp graph.
  <a name="mousepresshook">mouse-press-hook</a>   (snd chn button state x y) 
                                        called upon mouse button press within lisp graph.
  <a name="mousereleasehook">mouse-release-hook</a> (snd chn button state x y) 
                                        called upon mouse button release within lisp graph.
  <a name="multichannelmixhook">multichannel-mix-hook</a> (ids)         called when a multichannel mix happens in a sync'd sound.
                                        <i>ids</i> is a list of mix id numbers.  See mix.scm for an example.
  <a name="muserrorhook">mus-error-hook</a> (error-type error-message) called upon mus_error. (<b>or</b>)
                                        If it returns #t, Snd ignores the error (it assumes you've handled it via the hook).
  <a name="nameclickhook">name-click-hook</a> (snd)               called when sound name clicked (<b>or</b>).
                                        If it returns #t, the usual informative minibuffer babbling is squelched.
  <a name="openhook">open-hook</a> (filename)                called each time a file is opened (before the actual open).  (<b>or</b>)
                                        If it returns #t, the file is not opened.
  <a name="outputcommenthook">output-comment-hook</a> (str)           called in Save-As dialog, passed current sound's comment, if any.
                                        If more than one hook function, results are concatenated.  
                                        If none, the current comment is used.
<small>
                                      (add-hook! output-comment-hook 
                                        (lambda (str) 
                                          (string-append "written " 
                                            (strftime "%a %d-%b-%Y %H:%M %Z" (localtime (current-time)))))) 
</small>
  <a name="outputnamehook">output-name-hook</a> ()                 called in File New dialog
  <a name="savehook">save-hook</a> (snd name)                called each time a file is about to be saved. (<b>or</b>)
                                        If it returns #t, the file is not saved.  <i>name</i> is #f unless 
                                        the file is being saved under a new name (as in sound-save-as).
  <a name="starthook">start-hook</a> (filename)               called upon start-up. (<b>or</b>)
                                        If it returns #t, snd exits immediately.
  <a name="startplayinghook">start-playing-hook</a> (snd)            called when a play request is triggered. (<b>or</b>)
                                        If it returns #t, snd does not play.
  <a name="stopplayingchannelhook">stop-playing-channel-hook</a> (snd chn) called when a sound finishes playing. (<b>or</b>)
  <a name="stopplayinghook">stop-playing-hook</a> (snd)             called when a sound finishes playing. (<b>or</b>)
  <a name="stopplayingregionhook">stop-playing-region-hook</a> (n)        called when a region finishes playing. (<b>or</b>)
  <a name="snderrorhook">snd-error-hook</a> (error-message)      called upon snd_error. (<b>or</b>)
                                        If it returns #t, Snd flushes the error (it assumes you've 
                                        reported it via the hook).
<small>
                                      (add-hook! snd-error-hook
                                        (lambda (msg) (play "bong.snd") #f))
</small>
  <a name="sndwarninghook">snd-warning-hook</a> (warning-message)  called upon snd_warning. (<b>or</b>)
                                        If it returns #t, Snd flushes the warning (it assumes you've 
                                        reported it via the hook).
<small>
                                      (define without-warnings
                                        (lambda (thunk)
                                          (define no-warning (lambda (msg) #t))
                                          (add-hook! snd-warning-hook no-warning)
                                          (thunk)
                                          (remove-hook! snd-warning-hook no-warning)))
</small>

  Channel-specific hooks:

  <a name="edithook">edit-hook</a> (<i>snd chn</i>)
  <a name="undohook">undo-hook</a> (<i>snd chn</i>)
 
     These are functions that return the hooks in question associated with the specified channel.
     edit-hook is called just before any attempt to edit the channel's data.  If it returns #t,
     the edit is aborted. So,

         (add-hook! (edit-hook) (lambda () #t))

     aborts any attempt to edit the data; this is even more restrictive than setting the read-only
     flag because the latter only refuses to overwrite the current data.  undo-hook is called
     just after any undo, redo, or revert that affects the channel.  You can use edit-hook to set
     up protected portions of the edit history:
<small>
         (define protect
           "(protect &amp;optional snd chn) disallows any edits before the current one"
           (lambda args
             (let* ((edit-pos (apply edit-position args))
                    (hook (apply edit-hook args)))
               (reset-hook! hook)
               (add-hook! hook 
                 (lambda ()
                   (let ((val (&lt; (apply edit-position args) edit-pos)))
                     (if val (report-in-minibuffer "protected"))
                     val))))))

         (define unprotect 
           "(unprotect &amp;optional snd chn) allows edits at any edit history position"
           (lambda args (reset-hook! (apply edit-hook args))))
</small>
</pre>
<hr>


<h3><a name="sndobjects">Snd's objects</a></h3>

<p>Snd presents its various data structures to the user as a list
of sounds, each with a list of channels, each with lists of edits,
marks, and mixes.  The sound data itself is accessed through
a variety of structure and functions, each aimed at a particular
kind of use.  One of the most commonly used is the <i>vct</i>.
But before launching into vcts, I need to explain a few things
about the following documentation.
</p>

<p>In the following lists, optional arguments are in italics (although
netscape sometimes displays them in bold face for some reason).
Each sound has an
associated "index" used to refer to it in all the
functions.  This somewhat arbitrary number is more
or less related to the sound's position in the
display of sounds (set the variable <a href="#showindices">show-indices</a>
to cause it to be displayed in front of the sound's name).
In the argument lists
below, <i>snd</i> as an argument refers to the sound's index, and defaults to the currently
selected sound.  Similarly, <i>chn</i> is the channel number, starting from 0, and defaults
to the currently selected channel.  So if there's only one sound active, and it has only
one channel, (cursor) (cursor 0), and (cursor 0 0) all refer to the same
thing.  If you want to refer to the currently selected sound, either use #f
as the sound index or the function selected-sound.
</p>
<p>
If the <i>snd</i> argument is a list, the first element of the list is
taken to be a mix id number, and the reference is to the underlying mix input
sound data.  That is, (frames 1) returns the number of frames (samples per channel)
in the sound whose current index is 1; (frames (list 1)) returns the frames in
the sound that underlies the mix whose id is 1.  Similarly (scale-by .5) scales
the currently selected sound by .5; (scale-by .5 (list 0) 2) scales the 3rd channel
of mix 0's input sound by .5.  I keep saying "underlying" because normally a
mix is viewed after it has gone through its console (the set of widgets displayed
in the time domain view -- these can affect the
amplitude, amplitude envelope, and sampling rate) -- next-mix-sample, for
example, refers to the processed form of the mix data, whereas next-sample
would refer to the original form.  I may extend this to accept a list of (more than one) mixes.
</p>

<p>In many cases, the <i>snd</i>, <i>chn</i>, and <i>reg</i> arguments
can be #t (for backwards compatibility, a few of them default to #t).
#t means "all" in this case; if <i>snd</i> is #t, all sounds are included,
so, for example, <code>(expand #t)</code> returns a list of the current
control panel expansion settings of all sounds, and
<code>(set! (ffting #t #t) #t)</code>
turns on the fft display in all channels of all sounds.
</p>

<p>When an error occurs, in most cases the function throws a tag such as 'no-such-sound,
'impossible-bounds, 'no-active-selection, etc.
The error tag is mentioned with the function in the form [<em class=error>no-such-channel</em>].
All the functions that take sound and channel args ("snd chn" below) can return the errors
'no-such-sound and 'no-such-channel; all the mix-related functions can return 'no-such-mix;
all the region-related functions can return 'no-such-region; to reduce clutter, I'll omit mention
of these below.
</p>
<hr>

<h3><a name="Vcts">Vcts</a></h3>
<p>
Many of the Snd and CLM functions handle vectors (arrays) of data; 
by defining a new vector type, named vct, and providing a package
of old-style array-processing calls upon that type, we can speed up many
operations by a factor of 30.  This is enough of a difference to warrant
the added complexity, I think.  A vct object can be viewed as a vector;
to make one, call <i>make-vct</i>.  It will be freed by the Guile
garbage collector when it can't be referenced any further.  To get 
an element of a vct, use <i>vct-ref</i>; similarly <i>vct-set!</i>
sets an element (the "!" appended to the setter functions is standard in Scheme;
another is the use of "?" where Common Lisp is more likely to use "-p").
Once created, a vct object can be passed to a variety of built-in
functions:</p>
<pre>
  (define hi (make-vct 100))
  (vct-fill! hi 3.14)
  (vct-scale! hi -1.0)
</pre>
<p>Now our vct object <i>hi</i> has 100 -3.14's. <p>
<pre>
  <a name="sndlist2vct">list-&gt;vct</a>         (lst)             return vct object with elements of list <i>lst</i>
  <a name="makevct">make-vct</a>          (len)             create vct struct of size <i>len</i>.
  sound-data-&gt;vct   (sdobj chan vobj) place sound-data channel data in vct 
  <a name="vctp">vct?</a>              (vobj)            #t if <i>vobj</i> is a <a href="#Vcts">vct</a> struct.
  <a name="vctadd">vct-add!</a>          (vobj1 vobj2)     vobj1[i] += vobj2[i], returns vobj1.
  <a name="vctcopy">vct-copy</a>          (obj)             return a copy of <i>obj</i>.
  <a name="vctdo">vct-do!</a>           (vobj proc)       vobj[i] = (funcall proc i).
  <a name="vctfill">vct-fill!</a>         (vobj val)        vobj[i] = val, returns vobj.
  <a name="vctlength">vct-length</a>        (vobj)            length of data array in vobj.
  <a name="vctmap">vct-map!</a>          (vobj proc)       vobj[i] = (funcall proc).
  <a name="vctmove">vct-move!</a>         (vobj new old)    v[new++] = v[old++], returns v
  <a name="vctmultiply">vct-multiply!</a>     (vobj1 vobj2)     vobj1[i] *= vobj2[i], returns vobj1.
  <a name="vctoffset">vct-offset!</a>       (vobj val)        vobj[i] += val, returns vobj.
  <a name="vctpeak">vct-peak</a>          (vobj)            abs max val in vobj
  <a name="vctref">vct-ref</a>           (vobj pos)        value in vobj's data at location pos.
  <a name="vctscale">vct-scale!</a>        (vobj scl)        vobj[i] *= scl, returns vobj.
  <a name="vctset">vct-set!</a>          (vobj pos val)    set vobj's data at location pos to val.
  <a name="vctsubtract">vct-subtract!</a>     (vobj1 vobj2)     vobj1[i] -= vobj2[i], returns vobj1.
  <a name="vct2list">vct-&gt;list</a>         (v1)              return list with elements of vct <i>v1</i>
  <a name="vct2samples">vct-&gt;samples</a>      (samp samps data <i>snd chn</i>) synonym for <a href="#sndsetsamples">set-samples</a>.
  vct-&gt;sound-data   (vobj sdobj chan) place vct data in sound-data
  <a name="vct2soundfile">vct-&gt;sound-file</a>   (fd vobj vals)    write <i>vals</i> floats from <i>vobj</i> to <i>fd</i>.
  <a name="vctsdo">vcts-do!</a>          (vobj... proc)    vobj[vi][i] = (nth vi (funcall proc num i)).
  <a name="vctsmap">vcts-map!</a>         (vobj... proc)    vobj[vi][i] = (nth vi (funcall proc num)).
  <a name="sndvector2vct">vector-&gt;vct</a>       (vect)            return vct object with elements of vector <i>vect</i>
</pre>
<p>Many of the functions described below can take a vct object as an argument; 
there are also several functions that create and fill vcts with data:</p>
<pre>
  <a href="#sndregionsamples2vct">region-samples-&gt;vct</a> (<i>samp samps reg chn v</i>)
  <a href="#samples2vct">samples-&gt;vct</a> (<i>samp samps snd chn v pos</i>)  
  <a href="#transformsamples2vct">transform-samples-&gt;vct</a> (<i>snd chn v</i>)
</pre>
<p>There are four slightly
unusual functions in this family: <i>vct-map!</i>, <i>vct-do!</i>, <i>vcts-map!</i>, and <i>vcts-do!</i>.
These are essentially providing a do-loop over one or more vcts, calling some 
Scheme function to get the values to assign into the vct(s).  For example</p>
<pre>
  (vct-map! out-data (lambda () 
                       (convolve cnv (lambda (dir) 
                                       (next-sample sf)))))
</pre>
<p>in the cnvtest function in examp.scm is calling the convolve generator and
assigning the result to each successive member of the out-data vct.  <i>vct-do!</i>
is the same as <i>vct-map!</i> except that the called function should take one
argument, the current loop index.  Similarly, <i>vcts-map!</i> and <i>vcts-do!</i>
take any number of vcts, followed by a trailing function, and map the function's
results (assumed to be a list that matches the current number of vcts) into the
vct array.  In the map! case, the function takes one argument, the current number
of vcts awaiting values; in the do! case, it takes two arguments, the vct
number and the current loop index.  For example, we could rewrite the cnvtest
function to take stereo sounds:
</p>
<pre>
<small>
(define cnvtest
  (lambda (snd0 snd1 amp0 amp1)
    (if (and (= (channels snd0) 2)
	     (= (channels snd1) 2))
	(let* ((flt-len (frames snd0))
	       (total-len (+ flt-len (frames snd1)))
	       (cnv10 (make-convolve :filter (samples-&gt;vct 0 flt-len snd0 0)))
	       (cnv11 (make-convolve :filter (samples-&gt;vct 0 flt-len snd0 1)))
	       (sf10 (make-sample-reader 0 snd1 0))
	       (sf11 (make-sample-reader 0 snd1 1))
	       (out-data10 (make-vct total-len))
	       (out-data11 (make-vct total-len)))
	  (<em class=red>vcts-map!</em> out-data10 out-data11 
		     (lambda (num)
		       (list
			(convolve cnv10 (lambda (dir) (next-sample sf10)))
			(convolve cnv11 (lambda (dir) (next-sample sf11))))))
	  (free-sample-reader sf10)
	  (free-sample-reader sf11)
	  (vct-scale! out-data10 amp0)
	  (vct-scale! out-data11 amp1)
	  (vct-&gt;samples 0 total-len out-data10 snd1 0)
	  (vct-&gt;samples 0 total-len out-data11 snd1 1))
	(snd-print "oops -- need stereo input"))))
</small>
</pre>

<p>We can use vcts to write new sound files:</p>
<pre>
  <b>open-sound-file</b> (name chans srate comment)   ; returns fd
  <b>vct-&gt;sound-file</b> (fd vct vals)                ; writes vals floats to fd
  <b>close-sound-file</b> (fd vals)
</pre>
<p>After opening the file, loop through the data calling samples-&gt;vct, deal with the
vct data as desired, write the samples to the file via vct-&gt;sound-file, then
when finished, close-sound-file.  If the new data is to replace the old,
call (set! (samples...) data) with the new sound file's name; otherwise call insert-samples.
</p>
<hr>

<h3><a name="sndsndlib">Sound-data and Sndlib</a></h3>

<p>Another sound data object is the sound-data array used in Sndlib.</p>
<pre>
  make-sound-data (chans, frames)      return a sound-data object with <i>chans</i> arrays, each of length <i>frames</i>
  sound-data-ref (obj chan frame)      return (as a float) the sample in channel <i>chan</i> at location <i>frame</i>
  sound-data-set! (obj chan frame val) set <i>obj</i>'s sample at <i>frame</i> in <i>chan</i> to (the float) <i>val</i>
  sound-data? (obj)                    #t if <i>obj</i> is of type sound-data
  sound-data-length (obj)              length of each channel of data in <i>obj</i>
  sound-data-chans (obj)               number of channels of data in <i>obj</i>
  sound-data-&gt;vct (sdobj chan vobj)    place sound-data channel data in vct 
  vct-&gt;sound-data (vobj sdobj chan)    place vct data in sound-data
</pre>

<p>In fact, all of the underlying sound library (<a href="sndlib.html">Sndlib</a>)
functions are available, as well as all of (<a href="grfsnd.html#clmfuncs">CLM</a>).
The most important Sndlib functions for Snd are:</p>
<pre>
  mus-audio-close (line)              close audio port <i>line</i>
  <a name="describeaudiostate">mus-audio-describe</a> ()               describe audio hardware state (in help window)
  <a name="audioerror">mus-audio-error</a> ()                  returns error code indicated by preceding audio call
  <a name="audioerror-name">mus-audio-error-name</a>(err)           string decription of error code
  mus-audio-open-input (device srate chans format bufsize)
                                      open audio port <i>device</i> ready for input with indicated attributes
  mus-audio-open-output (device srate chans format bufsize)
                                      open audio port <i>device</i> ready for output with indicated attributes
  <a name="sndaudiooutputs">mus-audio-outputs</a>     (speakers headphones line-out) (Sun only) set active outputs
  mus-audio-read (line sdata frames)  read <i>frames</i> of data into sound-data object <i>sdata</i> from port <i>line</i>
  mus-audio-write (line sdata frames) write <i>frames</i> of data from sound-data object <i>sdata</i> to port <i>line</i>
  mus-sound-close-input (fd)          close sound file
  mus-sound-close-output (fd bytes)   close sound file and update its length indication, if any
  <a name="soundcomment">mus-sound-comment</a> (filename)        header comment, if any
  <a name="soundformatname">mus-data-format-name</a> (format)       e.g. "16-bit big endian linear"
  <a name="soundtypename">mus-header-type-name</a> (type)         e.g. "AIFF"
  <a name="sounddataformat">mus-sound-data-format</a>(filename)     data format (e.g. <i>mus-bshort</i>)
  <a name="sounddatalocation">mus-sound-data-location</a> (filename)  location of first sample (bytes)
  <a name="soundduration">mus-sound-duration</a> (filename)       duration of sound in seconds
  <a name="soundframes">mus-sound-frames</a> (filename)         frames of sound according to header (can be incorrect)
  <a name="soundchans">mus-sound-chans</a> (filename)          number of channels (samples are interleaved)
  <a name="soundheadertype">mus-sound-header-type</a> (filename)    header type (e.g. <i>mus-aifc</i>)
  <a name="soundlength">mus-sound-length</a> (filename)         true file length (bytes)
  mus-sound-max-amp(filename)         returns a vector of max amps and locations thereof
  mus-sound-open-input (filename)     open filename (a sound file) returning an integer ("fd" below)
  mus-sound-open-output (filename srate chans data-format header-type comment)
                                      create a new sound file with the indicated attributes, return "fd"
  mus-sound-read (fd beg end chans sdata)  
                                      read data from sound file <i>fd</i> loading the data array from beg 
                                      to end. <i>sdata</i> is a sound-data object that should be able to 
                                      accomodate the read
  mus-sound-reopen-output (filename chans data-format header-type data-location)
                                      reopen (without disturbing) filename, ready to be written
  <a name="soundsamples">mus-sound-samples</a> (filename)        samples of sound according to header (can be incorrect)
  mus-sound-seek (fd offset origin)   complicated -- see mus_sound_seek above
  mus-sound-seek-frame (fd frame)     move to <i>frame</i> in sound file <i>fd</i>
  <a name="soundsrate">mus-sound-srate</a> (filename)          sampling rate
  <a name="setossbuffers">set-oss-buffers</a> (num size) in Linux (OSS) sets the number and size of the OSS "fragments"
  <a name="soundloopinfo">mus-sound-loop-info</a> (filename)      loop info (for an example, see examp.scm mark-loops)
  <a name="setsoundloopinfo">set-sound-loop-info</a> (start0 end0 <i>start1 end1 snd</i>)   
                                      set loop points in header -- start0 refers to the "sustain" loop, 
                                      start1 to the "release".
  mus-sound-write (fd beg end chans sdata) write data to sound file <i>fd</i>
</pre>
<p>See <a href="sndlib.html">Sndlib</a> for more information on these functions. 
</p>
<hr>


<h3><a name="samplereaders">Sample-readers</a></h3>
<p>
The simplest data access function is <i>sample</i>, returning the sample at
a given position in a sound's channel.  This simplicity, however, comes at
a price in computation:  if the desired sample is not in Snd's
in-core (already loaded) view of the data, it has to access the sample,
which can sometimes involve opening, reading, and closing a sound file.
The result is that in some cases, <i>sample</i> will bring your function
to a grinding halt.  There are two alternatives, leaving aside the scanning
and mapping functions mentioned below.  One involves keeping the buffer of
data around explicitly (<i>samples-&gt;vct</i>), and the other involves the
use of a special object known as a <i>sample-reader</i>.  The former is
better if you're jumping around in the data, the latter if you're treating
it generally as a stream of samples, read in order.  The <a href="grfsnd.html#expsrc">expsrc</a>
function below shows how to use <i>samples-&gt;vct</i>; there are numerous
examples of <i>sample-readers</i> in examp.scm.  The basic idea is that
you create a reader (via <i>make-sample-reader</i> or <i>make-region-sample-reader</i>) giving it the start position, the sound and channel
to read, and the initial read direction, then get data via <i>next-sample</i> and
<i>previous-sample</i>, finally closing the reader with <i>free-sample-reader</i>.
It is not strictly necessary to call <i>free-sample-reader</i> yourself; the
garbage collector will handle this if necessary.
A standard way to add something to the current
data is:</p>
<pre>
   ...
   (sf (make-sample-reader start))
   ...
   (vct-map! out-data (lambda () (+ (next-sample sf) &lt;new stuff&gt;))
   (free-sample-reader sf)
   (vct-&gt;samples start len out-data)
</pre>
<p>This is largely equivalent to the clm call</p>
<pre><small>
  (outa (+ start i) &lt;new-stuff&gt;)
</small></pre>
<p>but is applied as an edit to the current state in Snd.  In general, slow
things in Guile are vector references, floating point operations, and
any do loop executed on a per-sample basis.  In most cases, these can
be collected into vct operations or through the use of functions like
formant-bank.
</p>

<p>There is a similar set of functions giving access to the mix data.
<i>make-mix-sample-reader</i> returns a mix reader for the desired mix,
<i>mix-sample-reader?</i> returns #t if its argument in a mix sample reader,
<i>next-mix-sample</i> returns the next sample (before it is mixed into
the output), and <i>free-mix-sample-reader</i> releases a reader.
Mixes can be collected into tracks, so there are also <i>make-track-sample-reader</i>, <i>track-sample-reader?</i>,
<i>next-track-sample</i>, and <i>free-track-sample-reader</i>.
As mentioned above, the mix-sample-reader refers to the mix data after
it has been processed through its console.  The original (possibly
edited) sound can be accessed by a normal sample-reader.
</p>
<pre>
  <a name="freemixsamplereader">free-mix-sample-reader</a>(obj)     release <a href="#samplereaders">mix-sample-reader</a> <i>obj</i>.
  <a name="freesamplereader">free-sample-reader</a>(obj)         release <a href="#samplereaders">sample-reader</a> <i>obj</i>.
  <a name="freetracksamplereader">free-track-sample-reader</a>(obj)   release <a href="#samplereaders">track-sample-reader</a> <i>obj</i>.
  <a name="makemixsamplereader">make-mix-sample-reader</a>(mix)     create a <a href="#samplereaders">mix-sample-reader</a> object reading <i>mix</i>
  <a name="mixsamplereaderQ">mix-sample-reader?</a>(obj)         #t if <i>obj</i> is a <a href="#samplereaders">mix-sample-reader</a>.
  <a name="makeregionsamplereader">make-region-sample-reader</a>(<i>start reg chn dir</i>) 
                                  create a <a href="#samplereaders">sample-reader</a> object reading region <i>reg</i>'s channel <i>chn</i>
  <a name="makesamplereader">make-sample-reader</a>(<i>start snd chn dir pos</i>) 
                                  create a <a href="#samplereaders">sample-reader</a> object reading <i>snd</i>'s channel <i>chn</i>
                                  starting at sample <i>start</i> with initial read direction <i>dir</i> 
                                  (1=forward, -1=backward).  <i>pos</i> is the edit history position to read 
                                  (defaults to current position). One use of <i>pos</i> is to get the difference 
                                  between two edits:
<small>
                                    (define snd-diff
                                      (lambda () ;assume mono, get diff between current state and previous
                                        (let* ((index (selected-sound))
                                               (edit-pos (edit-position index))
                                               (previous-edit (<em class=red>make-sample-reader</em> 0 0 index 1 (1- edit-pos))))
                                          (lambda (x)
                                            (- x (next-sample previous-edit)) #f))))
                                    (map-chan (snd-diff))
</small>
                                  <i>snd</i> can also be a filename (a string); in this way a sample-reader
                                  can read external sounds without going to the trouble of loading them into Snd.
<small>
                                    (define reader (make-sample-reader 100 "oboe.snd"))
</small>
  <a name="maketracksamplereader">make-track-sample-reader</a>(track samp snd chn)     
                                  create a <a href="#samplereaders">track-sample-reader</a> object reading <i>track</i>
  <a name="nextmixsample">next-mix-sample</a>   (obj)         return next sample read by <a href="#samplereaders">mix-sample-reader</a> <i>obj</i>.
  <a name="nextsample">next-sample</a>       (obj)         return next sample read by <a href="#samplereaders">sample-reader</a> <i>obj</i>.
  <a name="nexttracksample">next-track-sample</a> (obj)         return next sample read by <a href="#samplereaders">track-sample-reader</a> <i>obj</i>.

  <a name="previoussample">previous-sample</a>   (obj)         return previous sample in stream read by <a href="#samplereaders">sample-reader</a> <i>obj</i>.

  <a name="samplereaderatendQ">sample-reader-at-end?</a> (obj)     #t if <a href="#samplereaders">sample-reader</a> <i>obj</i> is at EOF.
  <a name="samplereaderQ">sample-reader?</a>    (obj)         #t if <i>obj</i> is a <a href="#samplereaders">sample-reader</a>.

  <a name="tracksamplereaderQ">track-sample-reader?</a>(obj)       #t if <i>obj</i> is a <a href="#samplereaders">track-sample-reader</a>.
</pre>
<hr>

<h3><a name="sndmarks">Marks</a></h3>

<p>A mark is an object that refers to a particular sample.
Each mark has an associated sample number (<b>mark-sample</b>), name (<b>mark-name</b>), sync value (<b>mark-sync</b>), and
a globally unique id number (returned by <b>find-mark</b> or <b>add-mark</b>, for example).  
</p>
<pre>
  <a name="sndaddmark">add-mark</a>      (sample <i>snd chn</i>)  add mark at <i>sample</i>, returning mark id.
  <a name="sndbackwardmark">backward-mark</a> (<i>count snd chn</i>)   move back <i>count</i> marks (C-j).
  <a name="snddeletemark">delete-mark</a>   (<i>id</i>)              delete mark <i>id</i> (- C-m).
  <a name="snddeletemarks">delete-marks</a>  (<i>snd chn</i>)         delete all marks in <i>snd</i>'s channel <i>chn</i>
  <a name="sndfindmark">find-mark</a>     (samp <i>snd chn</i>)    return identifier of mark at sample <i>samp</i> or #f if none found.
                                    This identifier is used in calls such as <a href="#sndmarksample">mark-sample</a>.  Since marks
                                    can move around during editing, a unique 'tag' is needed to refer to a 
                                    particular mark. <i>samp</i> can also be a string; in this case <i>find-mark</i> 
                                    looks for a mark of that name.
  <a name="sndforwardmark">forward-mark</a>  (<i>count snd chn</i>)   move forward <i>count</i> marks (C-j).
  <a href="#markclickhook">mark-click-hook</a>(id)             called when a mark is clicked, return #t to squelch message.
  <a name="markcolor">mark-color</a>    red               color of mark indicator.
  <a name="sndmarkname">mark-name</a>     (<i>id</i>)              name of mark <i>id</i>; also (set! (mark-name id) name).
  <a name="sndmarksample">mark-sample</a>   (<i>id pos</i>)          position of mark <i>id</i> at edit history position <i>pos</i>; also (set! (mark-sample id) samp)
  <a name="sndmarksync">mark-sync</a>     (<i>id</i>)              mark <i>id</i>'s sync value; also (set! (mark-sync id) sync).
  <a name="sndmarksyncmax">mark-sync-max</a> ()                max mark sync value seen so far.
  <a name="mark2sound">mark-&gt;sound</a>   (<i>id</i>)              sound and channel that hold mark <i>id</i>.
  <a name="emarks">marks</a>         (<i>snd chn pos</i>)     list of mark ids in <i>snd</i>'s channel <i>chn</i> at edit history position <i>pos</i>.
                                    If <i>chn</i> and <i>pos</i> are omitted, a list of lists is returned, 
                                    each inner list representing a channel of <i>snd</i>.  If <i>snd</i> is 
                                    also omitted, a list of lists of lists is returned, representing
                                    each sound and its channels.
  <a name="sndmarkok">mark?</a>         (<i>id</i>)              #t if mark <i>id</i> is active.
  <a name="sndsavemarks">save-marks</a>    (<i>snd</i>)             save <i>snd</i>'s marks, writing a file &lt;name&gt;.marks (returns file name).
  <a href="showmarks">show-marks</a>    #t                If #t, marks are displayed.  This is the '<a href="snd.html#marks">Show marks</a>' View menu option.
  <a name="syncdmarks">syncd-marks</a>   (sync)            list of marks (ids) that share sync.

</pre>

<p>The sync value is very similar to
the mix track number or the sound syncing field; it provides a way to group marks for simultaneous
changes.  Marks that share the same sync value (if not 0), move together when any one of them is
dragged, play together, etc.  <b>mark-&gt;sound</b> provides a way to go from a mark id to the sound and
channel that hold that mark; the inverse function is <b>marks</b>.  To find which marks share a given
sync value, use <b>syncd-marks</b>; to find an unused sync value use <b>mark-sync-max</b>. </p>
<pre>
(define (move-syncd-marks sync diff)
  (map (lambda (m) 
         (set! (mark-sample m) (+ (mark-sample m) diff))) 
       (<em class=red>syncd-marks</em> sync)))
</pre>
<p><b>marks</b>
without any argument, or with just a sound index returns a list of lists; each inner list is the list
of current marks (ids) active in that channel, ordered by sample number.  If the channel argument is
specified, <b>marks</b> returns just the list of mark ids.  If the edit history position is given,
the list of ids reflects the mark list at that time in the edit history.  So, for example, the
following procedure returns a list describing the history of a mark over the course of
editing a channel, each list entry being the mark sample at that time or #f if the mark was not active:
</p>
<pre>
(define (describe-mark id)
  (let ((mark-home (mark-&gt;sound id)))
    (if (eq? mark-home 'no-such-mark)
	;; not an active mark, so go scrounging for it
	;;   we're looking at every edit of every channel
	(do ((i 0 (1+ i)))
	    ((or (= i (max-sounds)) (list? mark-home)))
	  (if (sound? i)
	      (do ((j 0 (1+ j)))
		  ((or (= j (channels i)) (list? mark-home)))
		(let* ((max-edits (apply + (edits i j))))
		  (do ((k 0 (1+ k)))
		      ((or (&gt; k max-edits) (list? mark-home)))
		    (if (member id (<em class=red>marks</em> i j k))
			(set! mark-home (list i j)))))))))
    (if (list? mark-home)
	(let* ((snd (car mark-home))
	       (chn (cadr mark-home))
	       (max-edits (apply + (edits snd chn)))
	       (descr '())
	       (header (list 'mark id 'sound snd (short-file-name snd) 'channel chn)))
	  (do ((i max-edits (1- i)))
	      ((&lt; i 0) descr)
	    (if (member id (<em class=red>marks</em> snd chn i))
		(set! descr (cons (mark-sample id i) descr))
		(set! descr (cons #f descr))))
	  (cons header descr))
	'cant-find-mark)))
</pre>

<p>Marks that are syncd together can be used for insertions, and deletions, and can
set arbitrary groups of play points.  But it's a bit tedious to type (set! (mark-sync ...)...)
for each of the marks you want in the group.  The following uses the mark-clicked-hook
instead; you type (start-sync), then click the set of marks to sync, then (stop-sync).</p>
<pre>
(define mark-sync-number 0)
(define (start-sync) (set! mark-sync-number (+ (mark-sync-max) 1)))
(define (stop-sync) (set! mark-sync-number 0))
(define (click-to-sync id) (set! (mark-sync id) mark-sync-number) #f)
(add-hook! mark-click-hook click-to-sync)
</pre>
<p>Now control-click and drag one of them, and all move together deleting data, or
inserting zeros; or click the "play" triangle, and all play together starting from
the respective marks (which need not be in separate channels). See marks.scm for
more examples.</p>
<hr>

<h3><a name="sndmixes">Mixes</a></h3>

<p>A mix is an object that controls one channel of a sound mix; it normally includes
a "console" of widgets that can be pushed and poked to change various aspects of the
mix. In addition, all the signal-processing functions can be applied to the mix data.
These variables affect all mixes:</p>
<pre>
  <a name="mixcolor">mix-color</a>              lightgreen  color of mixer consoles.  
<small>
                       The set form (set! (mix-color) ...) has an optional second argument; if you
                       want to set just a particular mix's color, give the id of the mix
                       here. That is, (set! (mix-color) red) sets all unselected mix consoles to
                       red; but (set! (mix-color 3) red) sets only mix #3 to be red. Similarly,
                       mix-color has an optional argument that can specify which mix's color
                       we want.
</small>
  <a name="mixconsoleampscaler">mix-console-amp-scaler</a>   1.0       Multiplier on amp scales in mix consoles (see <a href="snd.html#mix-console-amp-scaler">mix consoles</a>). 
  <a name="mixconsolespeedscaler">mix-console-speed-scaler</a> 1.0       Multiplier on speed scales in mix consoles (<a href="snd.html#mix-console-speed-scaler">mix consoles</a>).
  <a name="mixfocuscolor">mix-focus-color</a>       yellow2      color of selected mix.
  <a name="mixwaveformcolor">mix-waveform-color</a>    darkgray     color of mix waveform.
  <a name="mixwaveformheight">mix-waveform-height</a>   20           Max height (pixels) of mix waveforms (see <a href="#showmixwaveforms">show-mix-waveforms</a>).
  <a name="withmixconsoles">with-mix-consoles</a>     #t           If #f, forego creation of mix consoles during mix operations.
</pre>
<p>Each mix object has a unique identifier used in the next set of functions to access
a particular mix object:</p>
<pre>
  <a name="sndbackwardmix">backward-mix</a>      (<i>count snd chn</i>) move back <i>count</i> mix consoles (C-x C-j).
  <a name="sndforwardmix">forward-mix</a>       (<i>count snd chn</i>) move forward <i>count</i> mix consoles (C-x C-j).
  <a name="mixes">mixes</a>             (<i>snd chn pos</i>) list of currently active mixes in <i>snd</i>'s channel <i>chn</i> at history <i>pos</i>.
  <a name="sndmixamp">mix-amp</a>           (<i>mix chan</i>)    amplitude of <i>mix</i>'s channel <i>chan</i>.
  <a name="sndmixampenv">mix-amp-env</a>       (<i>mix chan</i>)    amplitude envelope of <i>mix</i>'s channel <i>chan</i>.
  <a name="sndmixanchor">mix-anchor</a>        (<i>mix</i>)         anchor position (within the mix) of <i>mix</i>.
  <a name="sndmixchans">mix-chans</a>         (<i>mix</i>)         chans in <i>mix</i>.
  <a name="sndmixconsolestate">mix-console-state</a> (<i>mix</i>)         console state of <i>mix</i> (0=open, 1=title bar, 2=name[0]).
  <a name="sndmixconsoley">mix-console-y</a>     (<i>mix</i>)         console y offset in graph of <i>mix</i>
  <a name="sndmixlength">mix-length</a>        (<i>mix</i>)         length in samples of <i>mix</i>.
  <a name="sndmixlocked">mix-locked</a>        (<i>mix</i>)         #t if <i>mix</i> is locked.  
  <a name="sndmixname">mix-name</a>          (<i>mix</i>)         <i>mix</i>'s name.
  <a name="sndmixposition">mix-position</a>      (<i>mix</i>)         position (sample number) of <i>mix</i>.
  <a name="sndmixsoundchannel">mix-sound-channel</a> (<i>mix</i>)         channel affected by <i>mix</i>.
  <a name="sndmixsoundindex">mix-sound-index</a>   (<i>mix</i>)         index of sound affected by <i>mix</i>.
  <a name="sndmixspeed">mix-speed</a>         (<i>mix</i>)         speed of <i>mix</i>.
  <a name="sndmixtrack">mix-track</a>         (<i>mix</i>)         mix track (0 = none).
  <a name="sndmixok">mix?</a>              (<i>mix</i>)         #t if <i>mix</i> is active.
  <a name="sndplaymix">play-mix</a>          (<i>mix</i>)         play mix <i>mix</i>.
  <a name="sndplaytrack">play-track</a>        (<i>track snd chn</i>) play track <i>track</i>. If snd is #t, play all associated chans.
  <a name="sndselectmix">select-mix</a>        (<i>id</i>)          select mix <i>id</i>.
  <a name="sndselectedmix">selected-mix</a>      ()            selected mix (-1 = none).
  <a href="#showmixconsoles">show-mix-consoles</a>
  <a href="#showmixwaveforms">show-mix-waveforms</a>
</pre>
<p>As an example, say we have a mix active whose "id" is 123.</p>
<pre>
&gt;<em class=typing>(mix-chans 123)</em>
<em class=listener>1</em>
&gt;<em class=listener>(set! (mix-amp 123 0) .5)</em>
<em class=typing>.5</em>
</pre>
<p>This 
sets mix 123's channel 0 amplitude scaler to .5.
To mix data in such a way as to create an associated mix object:</p>
<pre>
  <a name="sndmix">mix</a> (file <i>samp in_chan snd chn with-mix-consoles</i>)
                      mix <i>file</i>'s channel <i>in_chan</i> starting at <i>samp</i> in <i>snd</i>'s channel <i>chn</i>.
                      if only the <i>file</i> argument is given, this is equivalent to the File menu's 
                      Mix option; the mix start sample in this case depends on the cursor location.
                      mix returns the id of the first channel's mix (subsequent channels simply 
                      increment this number). id of -1 means some error occurred.
                      If <i>with-mix-consoles</i> is #f (default is #t), the data is simply
                      mixed without creating any mix consoles [<em class=error>no-such-file</em>].

  <a name="sndmixregion">mix-region</a> (<i>samp scaler reg snd chn</i>)
                      Mix in region <i>reg</i> at sample <i>samp</i> (defaulting to the cursor sample), 
                      scaled by <i>scaler</i> (defaults to 1.0) in <i>snd</i>'s channel <i>chn</i>.
                      mix-region returns the id of the first channel's mix (subsequent channels simply 
                      increment this number). id of -1 means some error occurred.

  <a name="sndmixsound">mix-sound</a> (file start)  mix <i>file</i> into selected sound at <i>start</i> [<em class=error>no-such-file</em>].

  <a name="sndmixvct">mix-vct</a> (vct <i>beg in-chans snd chn with-mix-consoles</i>)
                      mix the contents of <i>vct</i> into <i>snd</i>'s channel <i>chn</i> starting at frame <i>beg</i>.
                      The data in the vct represent <i>in-chans</i> input channels, with samples 
                      interleaved. returns the id of the new mix, or -1 if some error occurred.
                      If <i>with-mix-consoles</i> is #f (default is #t), the data is simply
                      mixed without creating any mix consoles.
</pre>
<hr>

<h3><a name="sndregions">Regions</a></h3>

<p>A region is a saved portion of sound data.  There is a dialog to browse regions, and
a notion of a stack of regions.  As regions are added, old ones get pushed off the
stack and deleted.  The current selection is based on (and usually the same as) region 0.
The region number (e.g. 0) refers to its position in the region stack; each region also
has a unique identifier called its <i>id</i>.
Some of the <i>reg</i> arguments can be #t, referring to all current regions; 
these are indicated as <em class=targ>reg</em> below.
</p>

<pre>
  <a name="snddeleteregion">delete-region</a>     (<i>reg</i>)         delete region number <i>reg</i> (which defaults to 0).  This removes the
                                    region from the region stack; it doesn't edit the corresponding file(s).
  <a name="sndidregion">id-region</a>         (<i>id</i>)          map from region-id <i>id</i> to its current region stack location.
  <a name="sndinsertregion">insert-region</a>     (<i>beg reg snd chn</i>) insert region <i>reg</i> at sample <i>beg</i> in <i>snd</i>'s channel <i>chn</i>.
  <a name="sndmakeregion">make-region</a>       (beg end <i>snd chn</i>)
                                  create a new region spanning samples <i>beg</i> to <i>end</i> in <i>snd</i>'s channel <i>chn</i>.
                                    returns region's id.
  <a href="#makeregionsamplereader">make-region-sample-reader</a>(<i>start reg chn dir</i>) 
                                  create a <a href="#samplereaders">sample-reader</a> object reading region <i>reg</i>'s channel <i>chn</i>
  <a name="maxregions">max-regions</a>       16            Size of region stack.
  <a name="sndplayregion">play-region</a>       (<i>reg wait</i>)    play region <i>reg</i>, if wait is #t, play to end before returning.
  <a name="sndprotectregion">protect-region</a>    (reg protect) protect/unprotect region <i>reg</i> from deletion in the <a href="snd.html#regionbrowser">region browser</a>.
  <a name="sndregionchans">region-chans</a>      (<em class=targ>reg</em>)         number of channels in region <i>reg</i>.
  <a name="sndregionid">region-id</a>         (<em class=targ>reg</em>)         unique identifier attached to region <i>reg</i>.
  <a name="sndregionlength">region-length</a>     (<em class=targ>reg</em>)         number of samples (per channel) in region <i>reg</i>.
  <a name="sndregionmaxamp">region-maxamp</a>     (<em class=targ>reg</em>)         maximum amplitude of region <i>reg</i>.
  <a name="sndregionsample">region-sample</a>     (<i>samp reg chn</i>) value of sample <i>samp</i> in region <i>reg</i> in channel <i>chn</i>.
  <a name="sndregionsamples">region-samples</a>    (<i>samp samps reg chn</i>)
                                  return vector of <i>samps</i> samples starting at <i>samp</i> in region <i>reg</i>'s 
                                  channel <i>chn</i>.
  <a name="sndregionsamples2vct">region-samples-&gt;vct</a> (<i>samp samps reg chn v</i>)
                                  return vct struct of <i>samps</i> samples starting at <i>samp</i> in region <i>reg</i>'s 
                                    channel <i>chn</i>. If v (a vct object) is provided, it is filled, 
                                    rather than creating a new vct object.
  <a name="sndregionsrate">region-srate</a>      (<em class=targ>reg</em>)         original (nominal) sampling rate of region <i>reg</i>.
  <a name="eregions">regions</a>           ()            list of ids of regions currently active.
  <a name="regionok">region?</a>           (<i>reg</i>)         #t if region <i>reg</i> has data.
  <a name="sndsaveregion">save-region</a>       (reg filename <i>format</i>) 
                                  save region <i>reg</i> in <i>filename</i> in data format <i>format</i> (default mus-bshort) 
                                    [<em class=error>cannot-save</em>].
  <a name="sndselectall">select-all</a>        (<i>snd chn</i>)     create a new region spanning all samples in <i>snd</i>'s channel <i>chn</i>.
                                    returns region's id.
  <a name="sndselectregion">select-region</a>     (<i>reg</i>)         select region <i>reg</i> (i.e make it region 0).
</pre>

<p>These are specific to the current selection (these can return the error 'no-active-selection):</p>
<pre>
  <a name="sndconvolveselectionwith">convolve-selection-with</a> (file <i>amp</i>)     
                                  convolve the current selection with <i>file</i> 
  <a name="sndcut">cut</a>               ()            cut the current selection (a no-op if no active selection) 
  <a name="sndenvselection">env-selection</a>     (envelope <i>env-base snd chn</i>)
                                  apply <i>envelope</i> to the currently selected portion of <i>snd</i>'s channel <i>chn</i> 
  <a name="sndfilterselection">filter-selection</a>  (env order)   apply an FIR filter of order <i>order</i> and frequency response <i>env</i>
                                    to the current selection.  <i>env</i> can also be the filter coefficients
                                    themselves, in a vct object with at least order elements 
  <a name="sndplayselection">play-selection</a>    (<i>wait</i>)        play the currently selected data 
  <a name="sndreverseselection">reverse-selection</a> ()            reverse data delineated by current selection 
  <a name="sndsaveselection">save-selection</a>    (file <i>header-type data-format srate comment</i>)
                                  save the currently selected data in <i>file</i> 
  <a name="sndscaleselectionby">scale-selection-by</a>(<i>scalers</i>)     <a href="snd.html#scaling">scale</a> the current selection by <i>scalers</i> which can be either a float, 
                                    or a vector of floats 
  <a name="sndscaleselectionto">scale-selection-to</a>(<i>scalers</i>)     <a href="snd.html#scaling">normalize</a> the current selection to <i>scalers</i> which can be either a float, 
                                    or a vector of floats 
  <a name="selectionbeg">selection-beg</a>     ()            selection begin sample number 
  <a name="selectionlength">selection-length</a>  ()            selection frames 
  <a name="selectionmember">selection-member</a>  (<i>snd chn</i>)     #t if snd's chn is member of active selection.
  <a name="selectiontotemp">selection-to-temp</a> (<i>type format</i>) write out selected data as a temp file (see <a href="grfsnd.html#programs">external programs</a>) 
  <a name="selectiontotemps">selection-to-temps</a>(<i>type format</i>) write out selected data as temp files (see <a href="grfsnd.html#programs">external programs</a>) 
  <a name="selectionok">selection?</a>        ()            #t if selection is active.
  <a name="sndsmoothselection">smooth-selection</a>  ()            apply a smoothing function to the current selection 
  <a name="sndsrcselection">src-selection</a>     (num-or-env <i>base</i>) 
                                  same as <i>src</i> but applied to current selection 
  <a name="temptoselection">temp-to-selection</a> (data name origin) 
                                  read selected data from temp file (see <a href="grfsnd.html#programs">external programs</a>).
  <a name="tempstoselection">temps-to-selection</a>(data names origin) 
                                  read selected data from temp files (see <a href="grfsnd.html#programs">external programs</a>).
</pre>
<hr>


<h3><a name="sndsounds">Sounds and channels</a></h3>

<p>Some of the <i>snd</i> and <i>chan</i> arguments can be #t, referring to all current sounds or all channels of a sound; 
of these, some default to the currently selected sound if no argument is given, whereas others
(mainly for historical reasons) default to all sounds and channels;
the former are indicated as <em class=targ>snd</em> or <em class=targ>snd chn</em> below,
and the latter as <em class=narg>snd</em> or <em class=narg>snd chn</em>.
Also, in most of the signal-processing functions, the <i>snd</i> argument can also be
a list; in this case it refers to a mix.  For example, the <b>cursor</b> function,
which refers to the current cursor location, is listed here as:
</p>
<pre>
  cursor           (<em class=targ>snd chn</em>)     cursor location
</pre>
<p>which indicates that <code>(cursor 0 0)</code> returns the cursor location in sound 0, channel 0,
<code>(cursor)</code> returns the location in the currently selected sound, <code>(cursor #t #t)</code>
returns a list of lists of all the cursor locations, and <code>(set! (cursor) 0)</code> sets (just) the
cursor in the currently selected channel;
on the other hand, the <b>fft-size</b> function
is listed as:</p>
<pre>
  fft-size         (<em class=narg>snd chn</em>)     FFT size.
</pre>
<p>which means that <code>(fft-size 0 0)</code> returns the fft size used in sound 0, channel 0,
<code>(fft-size)</code> returns the globally effective fft size, <code>(fft-size #t #t)</code>
returns a list of lists of all the fft sizes, and <code>(set! (fft-size) 512)</code> sets all
fft sizes to 512.</p>

<p>The variables are local to each sound or each channel.
That is, <code>(amp snd)</code> returns the control-panel amp setting, and <code>(set! (amp snd) val)</code>
sets its value to val. 
</p>


<pre>
  <a name="addplayer">add-player</a>        (player)      add <i>player</i> to the play-list (see <a href="#makeplayer">make-player</a>). 
  <a name="sndamp">amp</a>               (<em class=targ>snd</em>)         current amp (control panel slider) value.
<small>
                                  It is possible to use these controls (in "real-time") in your own functions.
                                  See amprt in examp.scm for a simple example, and snd-gtk.scm for a complicated one. 
</small>
  <a name="sndappendtominibuffer">append-to-minibuffer</a> (msg <i>snd</i>)  append <i>msg</i> to whatever is in <i>snd</i>'s minibuffer [<em class=error>no-such-sound</em>].
  <a name="sndbackwardgraph">backward-graph</a>    (<i>count snd chn</i>) 
                                  move back (up or left) <i>count</i> graphs (C-x C-o).
  <a name="sndbackwardsample">backward-sample</a>   (<i>count snd chn</i>) 
                                  move back <i>count</i> samples (C-b), return new cursor position.
  <a name="bomb">bomb</a>              (<i>snd on</i>)      display bomb icon in <i>snd's</i> minibuffer.  Set <i>on</i> to #f to erase bomb.
  <a name="callapply">call-apply</a>        (<i>snd target</i>)  equivalent to pushing <i>snd</i>'s 'apply' button (this is intended 
                                  for internal testing); <i>target</i> can be 0=sound, 1=channel, 2=selection.
<small>
                                  call-apply can be used in conjunction with the various control panel variables:

                                    (define expnd 
                                      (lambda (amt) 
                                        (set! (expanding) #t) 
                                        (set! (expand) amt) 
                                        (<em class=red>call-apply</em>)))
</small>
  <a name="channels">channels</a>          (<em class=targ>snd</em>)         number of channels in <i>snd</i>.
  <a name="sndchans">chans</a>             (<em class=targ>snd</em>)         same as <i>channels</i> (the forgetful programmer's friend).
  <a name="sndclose">close-sound</a>       (<em class=targ>snd</em>)         close <i>snd</i> (same as File menu Close).
  <a name="sndcomment">comment</a>           (<em class=targ>snd</em>)         <i>snd</i>'s comment, if any.
  <a name="sndcontrast">contrast</a>          (<em class=targ>snd</em>)         current <a href="snd.html#contrast">contrast</a> (control panel slider) value.
  <a name="sndcontrastamp">contrast-amp</a>      (<em class=targ>snd</em>)         <i>snd</i>'s <a href="snd.html#contrast">contrast-amp</a> (control panel variable).
  <a name="sndcontrasting">contrasting</a>       (<em class=targ>snd</em>)         #t if <i>snd</i> has <a href="snd.html#contrast">contrast</a> turned on (control panel)
  <a name="sndconvolvewith">convolve-with</a>     (file <i>amp snd chn</i>)     
                                  convolve <i>snd</i>'s channel <i>chn</i> (or the currently sync'd data)
                                  with the data in the sound file <i>file</i>. <i>amp</i> is the resultant 
                                  peak amplitude (leave <i>amp</i> unset, or set it to #f to get the 
                                  unnormalized result) [<em class=error>no-such-file</em>].
<small>
                                  Convolve-with in conjunction with mix can provide high-quality reverb:

                                     (define conrev
                                       (lambda (impulse amp)
                                         (<em class=red>convolve-with</em> impulse amp)
                                         (save-sound-as "reverb.snd") ;let mix console scalers set reverb amount
                                         (revert-sound)
                                         (<em class=red>mix</em> "reverb.snd")))
</small>
  <a name="sndcursor">cursor</a>            (<em class=targ>snd chn</em>)     cursor location (samples) of channel <i>chn</i> of <i>snd</i>.
  <a name="sndcursorfollowsplay">cursor-follows-play</a>(<em class=targ>snd</em>)        #t if cursor is following along in the sound as it plays.
  <a name="cursorstyle">cursor-style</a>      (<em class=targ>snd chn</em>)     cursor style (<i>cursor-cross</i> or <i>cursor-line</i>)
<small>
                                  The following hooks set the cursor-style to cursor-line while playing if
                                  cursor-follows-play is #t:

                                    (define set-sound-cursor
                                      (lambda (snd shape)
                                        (do ((j 0 (1+ j)))
                                            ((= j (channels snd)) #f)
                                          (set! (<em class=red>cursor-style</em> snd j) shape))))

                                    (add-hook! start-playing-hook 
                                      (lambda (snd) (if (cursor-follows-play snd) (set-sound-cursor snd <em class=red>cursor-line</em>))))
                                    (add-hook! stop-playing-hook 
                                      (lambda (snd) (set-sound-cursor snd <em class=red>cursor-cross</em>)))
</small>
  <a name="snddataformat">data-format</a>       (<em class=targ>snd</em>)         <i>snd</i>'s data format (a list of the format number and its name).
  <a name="snddatalocation">data-location</a>     (<em class=targ>snd</em>)         <i>snd</i>'s data location (bytes).
  <a name="snddeletesample">delete-sample</a>     (samp <i>snd chn</i>) delete sample <i>samp</i> in <i>snd</i>'s channel <i>chn</i> [<em class=error>no-such-sample</em>].
  <a name="snddeletesamples">delete-samples</a>    (samp samps <i>snd chn</i>) 
                                  delete <i>samps</i> samples starting at sample <i>samp</i>.
  <a name="dotsize">dot-size</a>          (<em class=narg>snd chn</em>)     size in pixels of dots when graphing with dots (default: 1)
  <a name="sndenv">env-sound</a>         (envelope <i>samp samps env-base snd chn</i>)
                                  apply (in amplitude) <i>envelope</i> to <i>snd</i>'s channel <i>chn</i> starting
                                  at sample <i>samp</i> for <i>samps</i> samples with connecting segments
                                  based on <i>env-base</i>.  <i>env-base</i> defaults to 1.0 (line segments).
                                  <i>samp</i> defaults to 0.  <i>samps</i> defaults to the full duration.
                                  <i>envelope</i> is a list or vector containing the breakpoint values 
                                  (as in CLM).

                                      (env-sound '(0 0 1 1 2 0))

  <a name="sndexpand">expand</a>            (<em class=targ>snd</em>)         current <a href="snd.html#expand">expansion</a> amount (control panel).
  <a name="sndexpandhop">expand-hop</a>        (<em class=targ>snd</em>)         <i>snd</i>'s <a href="snd.html#expand">expansion</a> hop amount (seconds).
  <a name="sndexpandlength">expand-length</a>     (<em class=targ>snd</em>)         <i>snd</i>'s <a href="snd.html#expand">expansion</a> segment length (seconds).
  <a name="sndexpandramp">expand-ramp</a>       (<em class=targ>snd</em>)         <i>snd</i>'s <a href="snd.html#expand">expansion</a> ramp amount (between 0 and .5).
<small>
                                  This affects the smoothness of the grain overlaps -- .001 gives a 
                                  rattling effect (see make-control-dialog in snd-gtk.scm).
</small>
  <a name="sndexpanding">expanding</a>         (<em class=targ>snd</em>)         #t if <i>snd</i>'s expand button is on.
  <a name="fftbeta">fft-beta</a>          (<em class=narg>snd chn</em>)     The fft data <a href="snd.html#Xfftbeta">window parameter</a>, if relevant.
  <a name="fftlogfrequency">fft-log-frequency</a> (<em class=narg>snd chn</em>)     spectrum frequency axis is logarithmic (#t) or linear (#f) (default #f).
  <a name="fftlogmagnitude">fft-log-magnitude</a> (<em class=narg>snd chn</em>)     spectrum magnitude axis is in decibels (#t) or linear (#f) (default #f).
  <a name="lfftsize">fft-size</a>          (<em class=narg>snd chn</em>)     FFT size (default = 256).
  <a name="lfftstyle">fft-style</a>         (<em class=narg>snd chn</em>)     choice of spectral display.  The choices are (default) <i>normal-fft</i>, 
                                  <i>sonogram</i>, and <i>spectrogram</i>.
  <a name="lfftwindow">fft-window</a>        (<em class=narg>snd chn</em>)     fft data window (default: <i>blackman2-window</i>)
<small>
                                  rectangular-window hanning-window     welch-window      parzen-window
                                  bartlett-window    hamming-window     blackman2-window  blackman3-window
                                  blackman4-window   exponential-window riemann-window    kaiser-window
                                  cauchy-window      poisson-window     gaussian-window   tukey-window
</small>
  <a name="sndffting">ffting</a>            (<em class=targ>snd chn</em>)     #t if <i>snd</i>'s channel <i>chn</i> is displaying a spectrum (the 'f' button).
  <a name="sndfilename">file-name</a>         (<em class=targ>snd</em>)         <i>snd</i>'s complete file name.
  <a name="sndfilterenv">filter-env</a>        (<em class=targ>snd</em>)         <i>snd</i>'s <a href="snd.html#filter">filter</a> envelope (control panel).
  <a name="sndfilterdbing">filter-dBing</a>      (<em class=targ>snd</em>)         <i>snd</i>'s <a href="snd.html#filter">filter</a> dB button state (control panel).
  <a name="sndfilterorder">filter-order</a>      (<em class=targ>snd</em>)         <i>snd</i>'s <a href="snd.html#filter">filter</a> order (control panel).
  <a name="sndfilter">filter-sound</a>      (env order <i>snd chn</i>)
                                  apply an FIR filter of order <i>order</i> and frequency response <i>env</i>
                                  to <i>snd</i>'s channel <i>chn</i>.  <i>env</i> can also be the filter coefficients
                                  themselves, in a vct object with at least order elements (see <a href="grfsnd.html#gmeteor">gmeteor</a>).
  <a name="sndfiltering">filtering</a>         (<em class=targ>snd</em>)         #t if <i>snd</i> is filtering (control panel filter button).
  <a name="sndfindsound">find-sound</a>        (filename)    returns the index of <i>filename</i> (used as <i>snd</i> throughout).
                                  returns #f if no sound is found that matches <i>filename</i>.
  <a name="finishprogressreport">finish-progress-report</a> (<i>snd</i>)    see <a href="#progressreport">progress-report</a>.
  <a name="sndforwardgraph">forward-graph</a>     (<i>count snd chn</i>) 
                                  move forward (down or right) <i>count</i> graphs (C-x C-o).
  <a name="sndforwardsample">forward-sample</a>    (<i>count snd chn</i>) 
                                  move forward <i>count</i> samples (C-f), return new cursor position.
  <a name="sndframes">frames</a>            (<em class=targ>snd chn</em>)     <i>chn</i>'s current length in samples.
  <a name="sndgraph">graph</a>             (data <i>xlabel x0 x1 y0 y1 snd chn</i>)
                                  Display a graph of <i>data</i> in a separate display per channel.  The x axis
                                  is labelled <i>xlabel</i>, the x axis units go from x0 to x1 (default 0 to 1.0),
                                  the y axis goes from y0 to y1 (default fits the data), and the display is 
                                  associated with channel <i>chn</i> in <i>snd</i>.

                                      (graph #(0 .1 .2 .3 .4 .3 .2 .1 0) "roof")

                                  The current slider values can be read from <a href="#xpositionslider">x-position-slider</a>, 
                                  <a href="#xzoomslider">x-zoom-slider</a>, etc.  The <i>data</i> argument can be a list of vectors or
                                  vcts; each is graphed at the same time, following the sequence of
                                  colors used when channels are superimposed.  See examp.scm.
  <a name="graphstyle">graph-style</a>       (<em class=narg>snd chn</em>)     how sound data is displayed (default: <i>graph-lines</i>)
                                  The choices are:
<small>
                                  graph-lines        graph-dots         graph-filled      graph-lollipops   graph-dots-and-lines 
</small>
  <a name="sndgraphing">graphing</a>          (<i>snd chn</i>)     #t if (lisp) graph data is being displayed.
  <a name="graphshorizontal">graphs-horizontal</a> (<em class=narg>snd chn</em>)     determines whether channel graphs (time domain, spectrum, lisp graph) 
                                  are arranged vertically or horizontally.
  <a name="sndheadertype">header-type</a>       (<em class=targ>snd</em>)         return (type . name)
  <a name="sndinsertfile">insert-sound</a>      (file <i>in_chan snd chn</i>)
                                  insert channel <i>in_chan</i> of <i>file</i> at the cursor in <i>snd</i>'s channel <i>chn</i> 
                                  [<em class=error>no-such-file</em>].
  <a name="sndinsertsample">insert-sample</a>     (samp value <i>snd chn</i>)
                                  insert sample <i>value</i> at sample <i>samp</i> in <i>snd</i>'s channel <i>chn</i> 
                                  [<em class=error>no-such-sample</em>].
  <a name="sndinsertsamples">insert-samples</a>    (samp samps data <i>snd chn</i>)
                                  insert <i>samps</i> samples of <i>data</i> starting at sample <i>samp</i> in <i>snd</i>'s channel <i>chn</i>.
                                  <i>data</i> can be a filename; Snd assumes any such file is temporary; 
                                  it will be deleted when no longer needed.
  <a name="sndleftsample">left-sample</a>       (<em class=targ>snd chn</em>)     return the position in samples of the left edge of the time domain
                                  waveform for <i>snd</i>'s channel <i>chn</i>.
  <a name="linesize">line-size</a>         (<em class=narg>snd chn</em>)     Number of samples considered to be a 'line' (<a href="snd.html#cn">C-n</a> and <a href="snd.html#cp">C-p</a> commands). 
                                  default: 128.
  <a name="loopsamples">loop-samples</a>      (reader function calls origin)
                                  This calls external C functions while moving through the data accessed
                                  by the sample reader. loop-samples takes a sample reader, a pointer to a 
                                  (C) float function that takes one float argument (the current sample), 
                                  the number of times to call that function, and a name for the editing 
                                  operation for the edit history list.
  <a name="makeplayer">make-player</a>       (<em class=narg>snd chn</em>)     make a new player associated with <i>snd</i>'s channel <i>chn</i>.
                                  A <i>player</i> is a sort of wrapper for a channel of a sound that supports
                                  all the control-panel functions.  Once created, you can set these
                                  fields, then call <a href="#addplayer">add-player</a> to add this channel to the list of
                                  channels either being played (if a play is in progress) or about
                                  to be played.  Once some player is in the play-list, you can start 
                                  the play with <a href="#startplaying">start-playing</a>, and stop it prematurely with either 
                                  <a href="#stopplayer">stop-player</a> or <a href="#sndstop">stop-playing</a>.  These functions make it possible 
                                  to build custom control panels.  Here's a simple example that plays a 
                                  sound with individual amplitudes for the channels:
<small>
                                    (define play-with-amps
                                      (lambda (sound . amps)
                                        (let ((chans (chans sound)))
                                          (do ((chan 0 (1+ chan)))
                                              ((= chan chans))
                                            (let ((player (make-player sound chan)))
                                              (set! (amp player) (list-ref amps chan))
                                              (add-player player)))
                                          (start-playing chans (srate sound)))))

                                    (play-with-amps 0 1.0 0.5) ;plays channel 2 of stereo sound at half amplitude
</small>
                                  See also make-amp-controls in snd-gtk.scm.
  <a name="mapacrossallchans">map-across-all-chans</a> (func <i>start end edname</i>) 
                                  apply func to all open channels in parallel (see <a href="#scanning">Scanning Data</a>).
  <a name="mapacrosschans">map-across-chans</a>  (func <i>start end edname</i>) 
                                  apply func to currently syncd channels in parallel
  <a name="mapacrosssoundchans">map-across-sound-chans</a> (func <i>start end edname snd</i>) 
                                  apply func to sound's channels in parallel
  <a name="mapallchans">map-all-chans</a>     (func <i>start end edname</i>) 
                                  apply func to all open channels
  <a name="mapchan">map-chan</a>          (func <i>start end edname snd chn</i>) 
                                  apply func to samples in current channel 
  <a name="mapchans">map-chans</a>         (func <i>start end edname</i>) 
                                  apply func to currently syncd channels
  <a name="mapsoundchan">map-sound-chans</a>   (func <i>start end edname snd</i>) 
                                  apply func to current sound's channels
  <a name="sndmaxamp">maxamp</a>            (<em class=targ>snd chn</em>)     max amp of <i>snd</i>'s channel <i>chn</i>.
  <a name="maxfftpeaks">max-fft-peaks</a>     (<em class=narg>snd chn</em>)     max number of fft peaks reported (default: 100).
  <a name="sndmaxsounds">max-sounds</a>        ()            current size of sound array (grows as required).
  <a name="memosound">memo-sound</a>        #f            When a sound file is opened, Snd looks for a file with the same 
                                  name but with an appended ".scm" extension.  If such a file is found, 
                                  it is loaded automatically.  The variable <i>memo-sound</i> is set to 
                                  the newly opened sound's index.  This supports the "snd-memo" feature 
                                  in CLM, but can be used independently of CLM to store marks, selections,
                                  or whatever that you want associated with a particular sound. Confusingly
                                  enough, this is a Scheme variable, unlike all the others -- that is, you
                                  refer to it directly, not as a procedure call.
  <a name="mindb">min-dB</a>            (<em class=narg>snd chn</em>)     Sets the minimum dB value displayed in various graphs (default: -60.0).
  <a name="sndnew">new-sound</a>         (name <i>header-type data-format srate chans comment</i>)
                                  create a new (empty) sound named <i>name</i>.  If the <i>type</i> and other 
                                  arguments are not specified, a dialog is posted to get the needed 
                                  values which default to the current <a href="#defaultoutputtype">default-output-type</a> and 
                                  related settings.  Data formats are (b=big-endian, l=little, u=unsigned):
<small>
                                  mus-bshort  mus-lshort mus-mulaw  mus-alaw   mus-byte   mus-ubyte   mus-bfloat
                                  mus-lfloat  mus-bint   mus-lint   mus-b24int mus-l24int mus-bdouble mus-ldouble
                                  mus-ubshort mus-ulshort
</small>
                                  Header-types are:
<small>
                                  mus-next mus-aifc mus-riff mus-nist mus-raw mus-ircam mus-aiff
</small>
  <a name="normalizefft">normalize-fft</a>     (<em class=narg>snd chn</em>)     FFT normalization choice (default: <i>normalize-by-channel</i>)
                                  If normalize-by-channel (#t) or normalize-by-sound, spectral data is 
                                  normalized to 1.0 before display. If dont-normalize (#f), you get the 
                                  raw data values, which can reflect amplitude changes.  Snd tries to 
                                  choose a y axis limit that makes successive displays move smoothly.
  <a name="sndopenalternate">open-alternate-sound</a> (name)     close the currently selected file, if any, and open <i>name</i>.
                                  Returns #f if it can't open <i>name</i>, otherwise the new index.
  <a name="sndrawopen">open-raw-sound</a>    (name chans srate format) 
                                  open <i>name</i> as a raw (no header) sound in the layout specified.
                                  If the file has a header, it is not ignored (use override-data-format
                                  and friends if you want to ignore the header).
  <a name="sndopen">open-sound</a>        (name)        open <i>name</i> as in File menu Open option.
  <a name="overridedataformat">override-data-format</a> (format <i>snd</i>)force data format (ignore header)
  <a name="overridedatalocation">override-data-location</a> (loc <i>snd</i>) force data location (ignore header)
  <a name="overridedatasize">override-data-size</a> (samps <i>snd</i>)   force data size (ignore header)
  <a name="sndpeaks">peaks</a>             (<i>file snd chn</i>) display fft peak information.  If <i>file</i> is not null, write 
                                  the information to that file, else post it in a help window 
                                  (where it can be selected and pasted elsewhere).
  <a name="sndplay">play</a>              (<i>samp snd chn sync end</i>) 
                                  play <i>snd</i>'s channel <i>chn</i> starting from sample <i>samp</i>. 
                                  If 'sync' is #t, play all sounds syncd to snd.  If 'end' is not given, 
                                  play until end of sound. If 'end' is given (as a sample number), the 
                                  actual end point may be off by a few samples; Snd only checks on 
                                  dac-buffer boundaries (normally around 256 samples).
                                  [<em class=error>no-such-file, no-such-sound</em>]
  <a name="sndplayandwait">play-and-wait</a>     (<i>samp snd chn sync end</i>) 
                                  play <i>snd</i>'s channel <i>chn</i> starting from sample <i>samp</i> and wait 
                                  for it to finish.
  <a name="progressreport">progress-report</a>   (pct <i>name current-channel channels snd</i>)
                                  The functions <i>start-progress-report</i>, <i>progress-report</i>, and 
                                  <i>finish-progress-report</i> handle the animated hour-glass icon used 
                                  to amuse the idle user while some long computation is in progress.  
                                  The <i>pct</i> argument is a float between 0.0 and 1.0 which indicates how 
                                  far along we are in the computation (there are actually only 20 separate 
                                  icons, so there's no point in calling this more often than that).  
                                  start-progress-report posts the initial icon, and finish-progress-report 
                                  removes it.  If the icons are not available, a message is posted in 
                                  <i>snd's</i> minibuffer using <i>name</i> and so on to identify itself.
  <a name="sndpromptinminibuffer">prompt-in-minibuffer</a> (msg <i>callback snd</i>)
                                  Post <i>msg</i> in <i>snd</i>'s minibuffer, and when the user responds,
                                  call <i>callback</i> with the result and the <i>snd</i> (the sound's index).
                                  If <i>callback</i> is specified it should be either #f or a function of 
                                  two arguments [<em class=error>no-such-sound</em>].
<small>
                                    (define prompt-callback (lambda (func snd) (set! (sample 0) (func (sample 0)))))
                                    ;; here we're assuming the user will type a function in response to the prompt
                                    ;;   the value returned by the function will be the new sample 0 value
                                    ;;   the function should take one argument, the current sample 0 value
                                    (<em class=red>prompt-in-minibuffer</em> "sample 0 via func:" prompt-callback)
                                    ;; now if the user responds: (lambda (y) (+ y .5))
                                    ;; sample 0 will be set to itself + .5

                                  See eval-over-selection in examp.scm for a more useful example.
</small>
  <a name="sndreadonly">read-only</a>         (<em class=targ>snd</em>)         #t if <i>snd</i> is read-only, #f otherwise.
  redo              (<i>edits snd chn</i>) redo <i>edits</i> edits (default is 1) in <i>snd</i>'s channel <i>chn</i>.
  <a name="sndreportinminibuffer">report-in-minibuffer</a> (msg <i>snd</i>)  post <i>msg</i> in <i>snd</i>'s minibuffer [<em class=error>no-such-sound</em>].
  <a name="sndcontrolpanelreset">reset-control-panel</a> (<em class=targ>snd</em>)       clears the control panel.
  <a name="sndcontrolpanelrestore">restore-control-panel</a> (<em class=targ>snd</em>)     same as pushing the control panel '<a href="snd.html#savcontrols">r</a>' button.
  <a name="reverbdecay">reverb-decay</a>      (<em class=narg>snd</em>)         The length (seconds) of the reverberation after the sound has 
                                  finished (default: 1.0).
  <a name="sndreverbfeedback">reverb-feedback</a>   (<em class=targ>snd</em>)         <i>snd</i>'s reverb feedback coefficient.
  <a name="sndreverblength">reverb-length</a>     (<em class=targ>snd</em>)         <a href="snd.html#reverb">reverb</a> delay line length scaler (control panel).
  <a name="sndreverblowpass">reverb-lowpass</a>    (<em class=targ>snd</em>)         reverb low pass filter coefficient.
  <a name="sndreverbscale">reverb-scale</a>      (<em class=targ>snd</em>)         <a href="snd.html#reverb">reverb</a> amount (control panel).
  <a name="sndreverbing">reverbing</a>         (<em class=targ>snd</em>)         #t if <i>snd</i>'s reverb button is on.
  <a name="sndreverse">reverse-sound</a>     (<i>snd chn</i>)     reverse data.
  <a name="sndrevert">revert-sound</a>      (<i>snd</i>)         revert <i>snd</i> to saved state (undo all edits).
  <a name="sndrightsample">right-sample</a>      (<em class=targ>snd chn</em>)     position (samples) of right edge of time domain waveform.
  <a name="sndsample">sample</a>            (samp <i>snd chn</i>) value of sample <i>samp</i> in <i>snd</i>'s channel <i>chn</i>.
                                  If the desired sample happens to fall outside the current buffer 
                                  for the indicated channel, this function grinds to a halt -- if you're 
                                  running a loop through a bunch of samples, use the <a href="#samplereaders">sample-readers</a> 
                                  or samples-&gt;vct instead.
  <a name="sndsamples">samples</a>           (<i>samp samps snd chn pos</i>)
                                  return vector of <i>samps</i> samples starting at <i>samp</i> in <i>snd</i>'s channel <i>chn</i>.
                                  <i>samp</i> defaults to 0.  <i>samps</i> defaults to frames - samp.
                                  <i>pos</i> is the edit history position to read (defaults to current position).
  <a name="samples2sounddata">samples-&gt;sound-data</a> (<i>samp samps snd chn v pos sdchan</i>)  
                                  similar to samples-&gt;vct, but fill a sound-data object [<em class=error>no-such-edit</em>].
  <a name="samples2vct">samples-&gt;vct</a>      (<i>samp samps snd chn v pos</i>)  
                                  return vct struct with same data as in <i>samples</i> call above.  
                                  If v (a vct object) is provided, it is filled, rather than creating 
                                  a new vct object. <i>pos</i> is the edit history position to read.
  <a name="sndcontrolpanelsave">save-control-panel</a>(<em class=targ>snd</em>)         same as pushing the control panel '<a href="snd.html#savcontrols">s</a>' button.
  <a name="sndsave">save-sound</a>        (<em class=targ>snd</em>)         save <i>snd</i>; same as File menu's Save option.
  <a name="sndsaveas">save-sound-as</a>     (filename <i>snd header-type data-format srate channel</i>) 
                                  save <i>snd</i> as <i>filename</i> (same as File Save as option).  If channel is specified,
                                  only that channel is saved (extracted).
  <a name="sndscaleby">scale-by</a>          (<i>scalers snd chn</i>)
                                  <a href="snd.html#scaling">scale</a> amplitude of <i>snd</i> by <i>scalers</i>.  Unlike most of these functions,
                                  scale-by follows the 'sync' buttons and affects all currently sync'd 
                                  channels. <i>scalers</i> can be either a float or a vector of floats.  
                                  In the latter case, the values are used one by one, applying each as 
                                  scale-by moves through the channels. If 'sync' is off, channel <i>chn</i> 
                                  is scaled (defaults to the currently selected channel).
  <a name="sndscaleto">scale-to</a>          (<i>scalers snd chn</i>) 
                                  (see scale-by) -- <a href="snd.html#scaling">normalize</a> <i>snd</i> to <i>scalers</i>.
  <a name="scanacrossallchans">scan-across-all-chans</a> (func <i>start end</i>)
                                  apply func to all open channels in parallel (see <a href="#scanning">Scanning Data</a>).
  <a name="scanacrosschans">scan-across-chans</a> (func <i>start end</i>) 
                                  apply func to currently syncd channels in parallel
  <a name="scanacrosssoundchans">scan-across-sound-chans</a> (func <i>start end snd</i>) 
                                  apply func to sound's channels in parallel
  <a name="scanallchans">scan-all-chans</a>    (func <i>start end</i>) 
                                  apply func to all open channels
  <a name="scanchan">scan-chan</a>         (func <i>start end snd chn</i>) 
                                  apply func to samples in current channel (see <a href="#scanning">Scanning Data</a>).
  <a name="scanchans">scan-chans</a>        (func <i>start end</i>) 
                                  apply func to currently syncd channels
  <a name="scansoundchan">scan-sound-chans</a>  (func <i>start end snd</i>) 
                                  apply func to current sound's channels
  <a name="sndselectchannel">select-channel</a>    (<i>chn</i>)         select channel <i>chn</i>.
  <a name="sndselectsound">select-sound</a>      (<i>snd</i>)         select sound <i>snd</i>.
  <a name="sndselectedchannel">selected-channel</a>  (<i>snd</i>)         selected channel in <i>snd</i>.
  <a name="sndselectedsound">selected-sound</a>    ()            selected sound (index).
  <a name="contrastfunc">set-contrast-func</a> (func)        set contrast function to <i>func</i>, a function of two arguments, 
                                  the current sample and the current 'contrast' slider setting, 
                                  returning a new sample, the result of the control panel contrast 
                                  function; <i>func</i> replaces the built-in contrast function.
                                  Pass #f to return to the built-in version. Contrast-func returns 
                                  this function.
  <a name="expandfuncs">set-expand-funcs</a>  (expand make-expand free-expand)
                                  This function replaces the built-in Snd (control panel) expand with your own.
                                  See set-reverb-funcs below for an example.  The three arguments are
                                  the expand replacement, the function that makes or initializes any
                                  state the new expand function will need, and the function to free that
                                  state.  Set these to #f to return to the built-in versions.  The
                                  make-expand function takes three arguments, the current sound index,
                                  the current sampling-rate, and the initial expansion value (from the
                                  control panel); it can return an SCM object that is subsequently
                                  passed to the expand and free-expand functions.  The expand function
                                  takes 3 arguments, the thing returned by make-expand, the current
                                  sample (a float), and the current expansion slider value; it should
                                  return a float representing the new sample value.  The corresponding
                                  function reverb-funcs returns a list containing the three functions.
                                  expand-funcs returns a list containing these three functions.
  <a name="reverbfuncs">set-reverb-funcs</a>  (reverb make-reverb free-reverb)
                                  This function replaces the built-in Snd reverb with your own.
<small>
                                   (define outputs (make-vector 4))
                                   (define delay-line #f)
                                   (define delay-time 0.5)

                                   (set-reverb-funcs
                                     (lambda (ptr inval chans)
                                       (vector-set! outputs 0 (delay delay-line (+ (* .75 (tap delay-line)) inval)))
                                       outputs)
                                     (lambda (revlen srate chans)
                                       (set! delay-line (make-delay (inexact->exact (* srate delay-time))))
                                       delay-line)
                                     (lambda (ptr)
                                       ptr)
                                     )
</small>
                                  The three arguments are the reverb, the function that makes or
                                  initializes the reverb, and the function to free the reverb.  Set
                                  these to #f to return to the built-in versions.  The make-reverb
                                  function takes three arguments, the current value of the "len" slider,
                                  the current sampling-rate and the number of output channels active; it
                                  returns an SCM object that is subsequently passed to the reverb and
                                  free-reverb functions (ignored in the example above, as is the chans
                                  argument to the reverb function).  The reverb function takes 3
                                  arguments, the thing returned by make-reverb, the current reverb input
                                  sample, and the number of channels of output needed; it should return
                                  a vector of output reverb contributions.
  <a name="sndsetsamples">set-samples</a>       (samp samps data <i>snd chn trunc</i>) 
                                  set <i>snd</i>'s channel <i>chn</i>'s samples starting from
                                  sample <i>samp</i> for <i>samps</i> samples to the values in <i>data</i>.
                                  <small>(If <i>samp</i> is beyond the end of the file, the file is first zero-padded to reach it).</small>
                                  <i>data</i> can be a filename; Snd assumes any such file is temporary; it will
                                  be deleted when no longer needed.  If <i>trunc</i> is #t and <i>samp</i> is 0, the
                                  sound is truncated (if necessary) to reflect the end of <i>data</i>.
                                  The form (set! (samples samp samps <i>snd chn trunc</i>) data) can also be used.
  <a name="sndshortfilename">short-file-name</a>   (<em class=targ>snd</em>)         return the brief (no directory) form of <i>snd</i>'s filename.
  <a name="showaxes">show-axes</a>         (<em class=narg>snd chn</em>)     (default: show-all-axes)
                                  If show-all-axes, display x and y axes; if show-x-axis, 
                                  just one (bottom) x axis is displayed, reducing screen clutter. 
                                  The other choice is show-no-axes.
  <a name="showfftpeaks">show-fft-peaks</a>    (<em class=narg>snd chn</em>)     If #t, fft peak information is included in the fft display (default: #f).
                                  (This is the 'peaks' button in the <a href="snd.html#viewfft">Transform</a> options dialog).
  <a name="showmarks">show-marks</a>        (<em class=narg>snd chn</em>)     If #t, marks are displayed.  This is the '<a href="snd.html#marks">Show marks</a>' View menu option.
  <a name="showmixconsoles">show-mix-consoles</a> (<em class=narg>snd chn</em>)     If #t (the default), mix consoles are displayed.  This is 
                                  the '<a href="snd.html#consoles">Show consoles</a>' View menu option.
  <a name="showmixwaveforms">show-mix-waveforms</a>(<em class=narg>snd chn</em>)     If #t (default = #f), mixer console displays the waveform of the sound
                                  being mixed.
  <a name="showyzero">show-y-zero</a>       (<em class=narg>snd chn</em>)     If #t, the y=0 axis is displayed.  This is the '<a href="snd.html#viewy0">Show Y=0</a>' View menu option.
  <a name="sndshowingcontrols">showing-controls</a>  (<em class=targ>snd</em>)         #t if <i>snd</i>'s control panel is open.
  <a name="sndsmooth">smooth</a>            (beg num <i>snd chn</i>) 
                                  apply a smoothing function to the indicated data.
  <a name="sndok">sound?</a>            (<i>snd</i>)         #t if <i>snd</i> (an index) is active.
  <a name="soundfontinfo">soundfont-info</a>    (<i>snd</i>)         return a list of lists describing <i>snd</i> as a soundfont.  Each inner list
                                  consists of the sound name, start point, loop start, and loop end.
<small>  
                                  To set a named mark at the start of each sound with un-named marks 
                                  at the loop points:

                                    (define mark-sf2 
                                      (lambda ()
                                        (letrec ((sf2it (lambda (lst)
                                                          (if (not (null? lst))
                                                              (let ((vals (car lst)))
                                                                (let ((m1 (add-mark (cadr vals))))
                                                                  (set! (mark-name m1) (car vals)))
                                                                (add-mark (caddr vals))
                                                                (add-mark (cadddr vals))
                                                                (sf2it (cdr lst)))))))
                                           (sf2it (<em class=red>soundfont-info</em>)))))
</small>
  <a name="sounds">sounds</a>            ()            list of currently active sounds (id numbers).
<small>
                                  A common Snd trope is (map func (sounds)): (map maxamp (sounds)).  This can be
                                  extended to provide a complete list of sounds and channels (since many Snd functions
                                  take the "snd chn" arguments:

                                       (define all-chans
                                         (lambda ()
                                           (let ((sndlist '())
                                                 (chnlist '()))
                                             (map (lambda (snd)
                                                    (do ((i (1- (channels snd)) (1- i)))
                                                        ((&lt; i 0))
                                                      (set! sndlist (cons snd sndlist))
                                                      (set! chnlist (cons i chnlist))))
                                                  (<em class=red>sounds</em>))
                                             (list sndlist chnlist))))

                                      (apply map maxamp (all-chans))
</small>
  <a name="soundtotemp">sound-to-temp</a>     (<i>type format</i>) write out sync'd edit state as a temp file (see <a href="grfsnd.html#programs">external programs</a>).
  <a name="soundtotemps">sound-to-temps</a>    (<i>type format</i>) write out sync'd edit state as temp files (see <a href="grfsnd.html#programs">external programs</a>).

  <a name="spectrocutoff">spectro-cutoff</a>    (<em class=narg>snd chn</em>)     The amount of the frequency domain to include in the spectrum 
                                  display (default: 1.0). This number changes as you drag the frequency
                                  axis. This is the slider labelled '% of spectrum' in the View 
                                  Orientation dialog.
  <a name="spectrohop">spectro-hop</a>       (<em class=narg>snd chn</em>)     The distance (pixels) moved between successive spectrogram traces 
                                  (default = 4).  This is the 'hop' slider in the Orientation dialog.
  <a name="spectrostart">spectro-start</a>     (<em class=narg>snd chn</em>)     The start point of the frequency domain to include in the spectrum
                                  display (default 0.0).
  <a name="spectroxangle">spectro-x-angle</a>   (<em class=narg>snd chn</em>)     Default spectrogram x-axis viewing angle (default 90.0).
  <a name="spectroxscale">spectro-x-scale</a>   (<em class=narg>snd chn</em>)     Default scaler (stretch) along the spectrogram x axis (default 1.0).
  <a name="spectroyangle">spectro-y-angle</a>   (<em class=narg>snd chn</em>)     Same for y-axis (default 0.0).
  <a name="spectroyscale">spectro-y-scale</a>   (<em class=narg>snd chn</em>)     Same for y-axis (default 1.0).
  <a name="spectrozangle">spectro-z-angle</a>   (<em class=narg>snd chn</em>)     Same for z-axis (default -2.0).
  <a name="spectrozscale">spectro-z-scale</a>   (<em class=narg>snd chn</em>)     Same for z-axis (default 0.1).
  <a name="sndspeed">speed</a>             (<em class=targ>snd</em>)         current <a href="snd.html#speed">speed</a> (control panel).
  <a name="lspeedstyle">speed-style</a>       (<em class=narg>snd</em>)         In the control panel, the 'speed' control can be interpreted as a 
                                  float, (<i>speed-as-float</i>, the default), as a just-intonation ratio 
                                  of relatively small integers (<i>speed-as-ratio</i>) or as a step in a 
                                  microtonal scale (<i>speed-as-semitone</i>).  
  <a name="speedtones">speed-tones</a>       (<em class=narg>snd</em>)         The number of tones per octave in the <i>speed-as-semitone</i> speed 
                                  style (default: 12).
  <a name="squelchupdate">squelch-update</a>    (<em class=targ>snd chn</em>)     #t graphic updates are currently squelched (turned off).
  <a name="sndsrate">srate</a>             (<em class=targ>snd</em>)         <i>snd</i>'s sampling rate.
  <a name="sndsrc">src-sound</a>         (num-or-env <i>base snd chn</i>) 
                                  sampling rate conversion using 'warped sinc interpolation'.  The
                                  argument <i>num-or-env</i> can be either a number or an envelope.  In 
                                  the latter case, <i>base</i> sets the segment base (default is 1.0 = linear).
                                  A value greater than 1.0 causes the sound to be transposed up.
                                  A value less than 0.0 causes the sound to be reversed.  The envelope
                                  (if any) represents the difference of the new srate from 1.0 -- that is,
                                  (src-sound '(0 0 1 0)) is a no-op, whereas (src-sound '(0 0 1 1) moves
                                  up an octave over the course of the sound.
  <a name="startplaying">start-playing</a>     (<i>chans srate background</i>)  
                                  if a play-list is waiting, start it.  <i>chans</i> defaults to 1, 
                                  <i>srate</i> defaults to 44100, <i>background</i> defaults to #t.
  <a name="startprogressreport">start-progress-report</a> (<i>snd</i>)     see <a href="#progressreport">progress-report</a>.
  <a name="stopplayer">stop-player</a>       (player)      remove <i>player</i> from play-list(see <a href="#makeplayer">make-player</a>).
  <a name="sndstop">stop-playing</a>      (<i>snd</i>)         if <i>snd</i> is playing, stop it [<em class=error>no-such-sound</em>].
                                  If no argument is given, stop all sounds (channels) in progress.
  <a name="swapchannels">swap-channels</a>     (<i>snd1 chn1 snd2 chn2 beg dur</i>)
                                  Swap the indicated channels, between beg and beg+dur.
  <a name="sndsyncing">syncing</a>           (<em class=targ>snd</em>)         <i>snd</i>'s 'sync' value (an integer, 0=off)
  <a name="temptosound">temp-to-sound</a>     (data name origin) 
                                  read sync'd edit state from temp file (see <a href="grfsnd.html#programs">external programs</a>).
  <a name="tempstosound">temps-to-sound</a>    (data names origin) 
                                  read sync'd edit state from temp files (see <a href="grfsnd.html#programs">external programs</a>).
  <a name="sndtransformsample">transform-sample</a>  (<i>bin slice snd chn</i>)
                                  return the current value of the transform (if any) in <i>bin</i> and (if a 
                                  sonogram or spectrogram) <i>slice</i> in <i>snd</i>'s channel <i>chn</i> [<em class=error>no-such-sample</em>].
  <a name="sndtransformsamples">transform-samples</a> (<i>snd chn</i>)     return the transform data currently in <i>snd</i>'s channel <i>chn</i>.
  <a name="transformsamples2vct">transform-samples-&gt;vct</a> (<i>snd chn v</i>) 
                                  return vct struct with the transform data currently in <i>snd</i>'s channel <i>chn</i>.
                                  If v (a vct) is provided, it is filled, rather than creating a new vct.
  <a name="transformsize">transform-size</a>    (<i>snd chn</i>)     returns either 0 if no transform, fft-size if normal-fft, 
                                  or (list full-size bins slices) if sonogram or spectrogram.
  <a name="ltransformtype">transform-type</a>    (<em class=narg>snd chn</em>)     The spectrum transform type (default: <i>fourier-transform</i>).
<small>
                                  fourier-transform  wavelet-transform   hankel-transform    chebyshev-transform
                                  autocorrelation    walsh-transform     hadamard-transform  cepstrum
</small>
  undo              (<i>edits snd chn</i>) undo <i>edits</i> edits (default 1) in <i>snd</i>'s channel <i>chn</i>.
  <a name="snduniting">uniting</a>           (<em class=targ>snd</em>)         #f if channels are not superimposed or combined ('unite' button is off).
                                  The global name of this is channel-style.
  <a name="sndupdatefft">update-fft</a>        (<i>snd chn</i>)     recalculate <i>chn's</i> fft.
  <a name="sndupdategraph">update-graph</a>      (<i>snd chn</i>)     redisplay <i>chn's</i> graph(s).
  <a name="sndupdate">update-sound</a>      (snd)         update <i>snd</i> (re-reads data from disk, flushing any pending edits).
  <a name="sndview">view-sound</a>        (filename)    open <i>filename</i> read-only.
  <a name="verbosecursor">verbose-cursor</a>    (<em class=narg>snd chn</em>)     If #t, the cursor's position and other information is constantly 
                                  displayed in the minibuffer.  This is the View:Verbose cursor option 
                                  (default: #f).
  <a name="wavelettype">wavelet-type</a>      (<em class=narg>snd chn</em>)     If <i><a href="#ltransformtype">transform-type</a></i> is <i>wavelet-transform</i>, <i>wavelet-type</i> selects which 
                                  wavelet is used.  The list of available wavelets is in the Transform 
                                  Dialog. There are currently 20 choices, so this variable goes from 
                                  0 to 19 (default: 0).
  <a name="sndwaving">waving</a>            (<em class=targ>snd chn</em>)     the state of <i>snd</i>'s channel <i>chn</i>'s 'w' button.
  <a name="wavo">wavo</a>              (<em class=narg>snd chn</em>)     If #t, the time domain waveform is displayed as a '<a href="snd.html#wavogram">wavogram</a>'.
  <a name="wavohop">wavo-hop</a>          (<em class=narg>snd chn</em>)     This sets the distance upward between wavogram traces; that is,
                                  the smaller this number, the more traces can be displayed (default: 3).
  <a name="wavotrace">wavo-trace</a>        (<em class=narg>snd chn</em>)     This sets the length (samples) of each wavogram trace (default: 64).
  <a name="xaxisstyle">x-axis-style</a>      (<em class=narg>snd chn</em>)     The x axis labelling of the time domain waveform can be in seconds
                                  (<i>x-in-seconds</i>), in samples (<i>x-in-samples</i>), or expressed
                                  as a percentage of the overall duration (useful in envelope definitions).
                                  The latter is <i>x-to-one</i>. This is the View menu 'X-axis units' option.
                                  (default: <i>x-in-seconds</i>). 
  <a name="sndxbounds">x-bounds</a>          (<i>snd chn</i>)     return (x0 . x1) -- current x axis time domain bounds in seconds.
  <a name="xpositionslider">x-position-slider</a> (<em class=targ>snd chn</em>)     value of x axis position slider.
  <a name="xzoomslider">x-zoom-slider</a>     (<em class=targ>snd chn</em>)     value of x axis zoom slider.
  <a name="sndybounds">y-bounds</a>          (<i>snd chn</i>)     return (y0 . y1) -- current y axis bounds.
                                  To set the bounds to reflect the sound's maxamp, use (set! (y-bounds) '()).
  <a name="ypositionslider">y-position-slider</a> (<em class=targ>snd chn</em>)     value of y axis position slider.
  <a name="yzoomslider">y-zoom-slider</a>     (<em class=targ>snd chn</em>)     value of y axis zoom slider.
  <a name="zeropad">zero-pad</a>          (<em class=narg>snd chn</em>)     fft zero pad size as a multiple of the fft size; 
                                  (set! (zero-pad) 1) gives you half data, half zeros (default: 0).
</pre>

<h4><a name="customcontrols">the control panel</a></h4>

<p>
The control panel normally processes samples as follows: if the sampling
rate conversion is on (the 'Speed' control is not 1.0), it applies srate
conversion to the incoming sample; the next stage is the expansion function,
if the 'Expand' toggle button is set; this value is passed
next to the Contrast function, if it is running, and then the result
is scaled by the Amp slider's value.  The filter is run next, if
it's on, and finally the sample is scaled by the reverb slider and
passed to the reverb, if any, which adds its result to the sample;
the final result is sent to the speakers.  Besides the various user
interface controls, and variables such as expand-hop, you can also
change this sequence by replacing the contrast, expand, or reverb
functions with your own.  <b>set-contrast-func</b> replaces the
contrast-enhancement function; <b>set-reverb-funcs</b> replaces
the reverb, and <b>set-expand-funcs</b> replaces the expand function
(mus_granulate in CLM).  
</p>

<pre>
(set-expand-funcs 
  (lambda (ptr inval expval) (* expval inval))
  (lambda (snd srate expval) snd)
  (lambda (ptr) ptr))
</pre>

<p>turns the expand slider into another amplitude control.  There are
limits on what is possible here; on my old (132 MHz) SGI, even the
simplest function causes interruptions and stuttering.
</p>
<hr>


<h3><a name="editlists">Edit Lists</a></h3>

<p>An edit list describes the edit history of a channel.  When, for example, you type C-d, nothing actually
happens to any data, despite the fact that the graph no longer shows that sample, it's gone when you play the
channel, and so on.  What actually happens is that a descriptor is appended to the edit history of that
channel saying "sample n was deleted".  Undo and redo move around in this list (they simply move the
pointer to the current edit history position); all the positions are accessible just like the current
one, and are exposed in many functions described above as the <i>pos</i> argument. The edit list functions are:</p>
<pre>
  <a name="asoneedit">as-one-edit</a>   (func)        apply <i>func</i> (a function of no arguments), treating it as
                                one edit (in all channels) in the edit history mechanism.
<small>
                                     (<em class=red>as-one-edit</em> (lambda () (set! (sample 100) .1) (set! (sample 200) .2)))
</small>
  <a name="sndeditfragment">edit-fragment</a> (<i>num</i> <em class=targ>snd chn</em>) return a list similar to that displayed in the edit history window giving 
                                the origin of the specified edit, its type (delete, insert, etc), its 
                                begin sample (given the current edit tree), and the number of samples 
                                affected.  If num is omitted, return the last (currently active) 
                                edit [<em class=error>no-such-edit</em>].
  <a name="sndeditposition">edit-position</a> (<em class=targ>snd chn</em>)     return a current position in edit history list.
  <a name="sndedits">edits</a>         (<em class=targ>snd chn</em>)     return a list with number of undo-able edits and redo-able edits.
  revert-sound  (<i>snd</i>)         revert <i>snd</i> to saved state (undo all edits).
  <a name="sndsaveedithistory">save-edit-history</a> (filename <i>snd chn</i>)
                                save current edit list(s) in <i>filename</i>.
                                If <i>chn</i> is omitted, all <i>snd</i>'s channels are saved; if <i>snd</i> is omitted,
                                all edit list are saved.  If the underlying files are not subsequently 
                                changed, you can load this file to restore the current edit list state.
                                Returns #t if successful (file opened ok); if something went wrong 
                                [<em class=error>cannot-save</em>].
  <a name="sndredo">redo</a>        (<i>edits snd chn</i>) redo <i>edits</i> edits (default is 1) in <i>snd</i>'s channel <i>chn</i>.
  <a name="sndundo">undo</a>        (<i>edits snd chn</i>) undo <i>edits</i> edits (default 1) in <i>snd</i>'s channel <i>chn</i>.
</pre>

<p>It is sometimes more convenient to edit the edit history lists
directly, than to run Snd and invoke the <a href="snd.html#savedstate">"Save State"</a> menu option.
To save a particular sound's or channel's edit list(s), use the
function <a href="#sndsaveedithistory">save-edit-history</a>.
These lists are simply Scheme programs, just like anything else
discussed in this document.  You could even write them from
scratch.  Say we want to make a stereo file that consists
of four mono files mixed at various points; we know where they
should go, and we have religious objections to using a
graphical user interface.  So we create myfile.scm, and
put in it something like:</p>

<pre>
(let ((myfile (<a href="#sndnew">new-sound</a> "mysound.snd" mus-aifc-sound-file mus-bshort 44100 2 "this is my sound")))
	;; this is equivalent to the New file menu option
  (<a href="#sndmix">mix</a> "oboe.snd" 0 0 myfile 0)
  ;; this mixes in the mono file oboe.snd at sample 0 in channel 0
  ;; use (mix "oboe.snd" 0 0 myfile 0 #f) to forego the mix console
  (mix "pistol.snd" 0 0 myfile 1)
  ;; now pistol.snd is at sample 0 in channel 1
  (mix "fyow.snd" 10000 0 myfile 0)
  ;; add in fyow.snd at sample 10000 in the first channel
  (mix "cardinal.snd" 20000 0 myfile 1)
  ;; etc
  )
</pre>

<p>Now fire up Snd: <code>snd -l myfile.scm</code> and voila!
Files like this can contain any arbitrary Scheme code, calling
anything in Snd or anywhere else for that matter; you basically
have a CLM-like notelist reader to describe sound file edits.
Similarly, when you save Snd's state (via the Save State menu
option or by calling the function <a href="#sndsavestate">save-state</a>),
the result is a Scheme program that can be edited just like any
other such text.
</p>
<hr>

<h3><a name="scanning">Scanning Data</a></h3>

<p>Sound files can be enormous, far larger than available memory, so vector access to
sample data (as in <a href="#sndsetsamples">set-samples</a>) is not always very useful.
(Each sample setting call is treated as a separate edit by Snd, but we would normally
want the entire operation to be handled as one edit; we could wrap up all the sample setting
calls in <a href="#asoneedit">as-one-edit</a>, but it's a bit wasteful).
In addition, the collection of available channels of data in the editor can present
a complicated access problem.  The 14 scanning and mapping functions provide what
I hope is a straightforward answer to these problems.  The "scan" functions do
not change any data; they simply run through data presenting it to the caller.
The "map" functions can change data, if they wish; the entire mapping call
becomes one large editing operation from the editor's point of view.
There are four ways to get at the editor's data: one channel, a sound's
channels, all currently open channels, and all currently sync'd channels.
There are two ways to march through this collection of channels: in series
(that is, one channel at a time), and in parallel (all channels at once);
the former is the default, and for the latter, I use the word "across".
So map-chan maps a function over a single channel; map-chans affects
the currently syncd channels (in series); map-across-chans affects the
same set of channels, but they are presented to the caller's function
as an array, each element of the array being a channel's sample at the
current location in the map; map-all-chans affects all currently open
channels; and finally, map-sound-chans affects all of a sound's channels,
independent of the 'sync' button.  The 'scan' functions behave similarly.
In each case, an optional subsequence of the data can be requested via
'start' and 'end' points.  If beg is #f, it defaults to 0; if end is #f,
it defaults to the end of the channel.
</p>
<pre>
  <b>map-across-all-chans</b> (func <i>start end edname</i>)       apply func to all open channels in parallel
  <b>map-across-chans</b> (func <i>start end edname</i>)           apply func to currently syncd channels in parallel
  <b>map-across-sound-chans</b> (func <i>start end edname snd</i>) apply func to sound's channels in parallel
  <b>map-all-chans</b> (func <i>start end edname</i>)              apply func to all open channels
  <b>map-chan</b> (func <i>start end edname snd chn</i>)           apply func to samples in current channel
  <b>map-chans</b> (func <i>start end edname</i>)                  apply func to currently syncd channels
  <b>map-sound-chans</b> (func <i>start end edname snd</i>)        apply func to current sound's channels

  <b>scan-across-all-chans</b> (func <i>start end</i>)             apply func to all open channels in parallel
  <b>scan-across-chans</b> (func <i>start end</i>)                 apply func to currently syncd channels in parallel
  <b>scan-across-sound-chans</b> (func <i>start end snd</i>)       apply func to sound's channels in parallel
  <b>scan-all-chans</b> (func <i>start end</i>)                    apply func to all open channels
  <b>scan-chan</b> (func <i>start end snd chn</i>)                 apply func to samples in current channel
  <b>scan-chans</b> (func <i>start end</i>)                        apply func to currently syncd channels
  <b>scan-sound-chans</b> (func <i>start end snd</i>)              apply func to current sound's channels
</pre>
<p>In the case of the scanning operations, the function passed as the first argument takes
either the current sample (when scanning in series), or two arguments, the current
array of samples, and the array's length (when scanning in parallel).  If the function
returns something other than #f, the scan is stopped and (in the series case) a list is returned to
the caller containing the non-#f value returned, the current sample position of the
scan, the current channel number, and the current sound index; in the parallel case, the current
sample position is returned.  So, for example, the following call scans the
current channel from sample 0 to the end looking for any sample greater than
.1:</p>
<pre>
&gt;<em class=typing>(scan-chan (lambda (y) (&gt; y .1)))</em>
<em class=listener>(#t 4423 0 0)</em>
</pre>
<p>In this case, we found such a sample at position 4423 of the first channel of the
sound whose index is 0.  
Here's an example of scanning across all channels,
returning the maximum sample value found:</p>
<pre>
(define data-max 
  (lambda ()
    (let ((maxval 0.0))
      (scan-across-all-chans
        (lambda (data len)
	  (do ((i 0 (1+ i)))
	      ((= i len) #f)
	    (let ((curval (abs (vector-ref data i))))
	      (if (&gt; curval maxval) (set! maxval curval))))))
      maxval)))

&gt;<em class=typing>(data-max)</em>
<em class=listener>0.492675779232</em>

(define every-sample?
  (lambda (proc)
    (let ((baddy (scan-chan (lambda (y) (not (proc y))))))
      (if baddy (set! (cursor) (cadr baddy)))
      (not baddy))))

&gt;<em class=typing>(every-sample? (lambda (y) (&lt; y .5)))</em>
<em class=listener>#t</em>
</pre>
<p>The mapping operations are slightly more complicated because they
can edit the data.  The fourth argument <i>edname</i> is the
name of the editing operation that will be reported by the
edit history mechanism.  If none is given, it will default to
the name of the calling map function (which has little
to do with the actual edit).  The other arguments to the mapping
calls are the same as corresponding scanning calls.  The function
passed (and applied to the data) also takes the same arguments;
its return value is interpreted differently however.  The applied
function can return #f, which means that the data passed in is
deleted (replaced by nothing), or a number which replaces the
current sample (in the parallel case this is an array of numbers),
or #t which halts the mapping operation, leaving trailing samples
unaffected, or a list, vct object, or vector of numbers (in the parallel case,
an embedded array as an element of the outer array); in this
case, the numbers are spliced into the edited version, effectively
replacing the current sample with any number of samples. This sounds
more complicated than it is!  Basically, a map in series receives
each sample and returns either #f (no corresponding output), a number
(the new output), or a list of numbers; a map in parallel does the
same for each sample in the array passed to it. 
If every value returned for a given channel is #f, the data is not edited.
This makes it possible to run through all current channels in parallel,
changing only one channel (or a subset of them).
</p>
<pre>
&gt;<em class=typing>(map-chan (lambda (y) (+ y .2)))</em>
<em class=listener>#f</em>

&gt;<em class=typing>(map-chan (lambda (y) (cos y)) #f #f "(cos y)")</em>
<em class=listener>#f</em>

&gt;<em class=typing>(map-chan (lambda (y) (if (&gt; y .1) (list .1 .2 .3) y))) </em>
<em class=listener>#f</em>

(define swap-channels
  (lambda ()
    (if (= (channels) 2)
	(map-across-sound-chans
	 (lambda (data chans)
	   (let ((chan0-sample (vector-ref data 0)))
	     (vector-set! data 0 (vector-ref data 1))
	     (vector-set! data 1 chan0-sample)
	     data))
	 #f #f "swap-channels")
	(string-append (short-file-name) " is not stereo!"))))

</pre>
<p>The edit history may show multiple entries for a given map application;
it may have to delete the old samples before
inserting the new samples.  This means that you may have to repeat 'undo'
once or twice to get back to the state before the map operation. 
Wrap the call up in <a href="#asoneedit">as-one-edit</a> to get around this.
Here's a slightly more involved example;
we define a function that finds silences and replaces them with
something:<p>
<pre>
(define map-silence 
  (lambda (silence replacement)
    (let ((sum-of-squares 0.0)
	  (buffer (make-vector 128 0.0))
	  (position 0)
	  (current-sample 0)
	  (chan-samples (frames)))
      (lambda (y)
        (let ((old-y (vector-ref buffer position)))
	  (set! sum-of-squares (- (+ sum-of-squares (* y y)) (* old-y old-y)))
	  (vector-set! buffer position y)
	  (set! position (1+ position))
	  (if (= position 128) (set! position 0))
	  (set! current-sample (1+ current-sample))
	  (if (&gt; sum-of-squares silence)
	      (if (= current-sample chan-samples)
		  ;; at end return trailing samples as long as it looks like sound
		  (let ((temp-buffer (make-vector 128 0.0)))
		    (do ((i 0 (1+ i)))
			((= i 128) temp-buffer)
		      (let ((final-y (vector-ref buffer position)))
			(vector-set! temp-buffer i (if (&gt; sum-of-squares silence) final-y 0.0))
			(set! sum-of-squares (- sum-of-squares (* final-y final-y)))
			(set! position (1+ position))
			(if (= position 128) (set! position 0)))))
		  old-y)
	    replacement))))))

(map-chan (map-silence .01 0.0))  ; squelch background noise
(map-chan (map-silence .001 #f))   ; remove silences altogether
</pre>
<p>In case it isn't obvious, we're using <i>buffer</i> to hold a running
portion of the sound, and <i>sum-of-squares</i> to hold the sum of the squares
of all the samples in that portion.  When the portion's sum falls below
the argument <i>silence</i>, we replace the current sample with <i>replacement</i>.
At the end, we flush out all the remaining samples awaiting output in <i>buffer</i>.</p>

<p>It is possible to break out of a map, flushing any edits, via call-with-current-continuation:</p>
<pre>
(define ctr 0)
(call-with-current-continuation 
  (lambda (return)
    (map-chan (lambda (val)
                (set! ctr (1+ ctr)) 
                (if (> ctr 100) 
                  (return "quitting!") 
                  val)))))
</pre>
<p>If the editing action is not mapping something over the current sound, it is
safest to write a temp file with the new data, then pass that to set-samples
with the trunc argument set to #t.  This way you don't assume the new sound
will fit in memory (as in using vct->samples for example), nor that the
lengths will be more or less the same (as in the mapping operations).
Use snd-tempnam to get a temporary filename that reflects the current
temp-dir setting (if any).  The env-sound-interp function in examp.scm
is an example of this.</p>
<hr>


<h3><a name="sndtransforms">Transforms</a></h3>

<p>Except for add-transform, the transform functions and variables have been treated above, so this is just
a list of them with cross-references.</p>
<pre>
  <a name="addtransform">add-transform</a>   (name xlabel lo hi transform)

                  add-transform adds a transform to the transform tables.  <i>name</i> is the name
                  it will be listed by in the transform dialog. <i>xlabel</i> is the x axis label
                  of the resultant graph.  <i>lo</i> and <i>hi</i> set which portion of the returned data
                  is relevant in graphing (normally 0.0 to 1.0).  <i>proc</i> is a function of two 
                  arguments, the length of the desired transform, and a sample-reader that 
                  can be used to get the current data.  Do not free the sample-reader!  
                  The function should return a vct object containing the transform data.  
                  add-transform returns the new transform's transform-type.
                  Here's an example that displays a histogram of the current values in 16 bins:
<small>
                                      (<em class=red>add-transform</em> "histogram" "bins" 0.0 1.0 
                                        (lambda (len fd)
                                          (let ((v (make-vct len))
                                                (steps (/ len 16))
                                                (step (/ 1.0 len)))
                                            (do ((i 0 (1+ i))) ((= i len) v)
                                              (let* ((val (next-sample fd))
                                                     (bin (inexact->exact (* (abs val) 16.0))))
                                                (do ((j 0 (1+ j))) ((= j steps))
                                                  (vct-set! v (+ j bin) (+ step (vct-ref v (+ j bin))))))))))
</small>
                 And an example that lets us see the result of filtering the waveform:
<small>
                                     (add-transform "low-pass" "filtered" 0.0 1.0
                                       (lambda (len fd)
                                         (let ((v (make-vct len))
                                               (flt (make-fir-filter :order 80 
                                                                     :xcoeffs (let ((v1 (make-vct 80)))
                                                                                (vct-fill! v1 .0125)
                                                                                v1))))
                                           (do ((i 0 (1+ i))) ((= i len) v)
       	                                     (vct-set! v i (fir-filter flt (next-sample fd)))))))
</small>
  <a href="#sndffting">ffting</a> (<em class=targ>snd chn</em>)
  <a href="#fftbeta">fft-beta</a>
  <a href="#ffthook">fft-hook</a> (snd chn scaler)
  <a href="#fftlogfrequency">fft-log-frequency</a>
  <a href="#fftlogmagnitude">fft-log-magnitude</a>
  <a href="#lfftsize">fft-size</a>
  <a href="#lfftstyle">fft-style</a>
  <a href="#lfftwindow">fft-window</a>
  <a href="#maxfftpeaks">max-fft-peaks</a>
  <a href="#mindb">min-dB</a>
  <a href="#normalizefft">normalize-fft</a>
  <a href="#showfftpeaks">show-fft-peaks</a>
  <a href="#lshowselectiontransform">show-selection-transform</a>
  <a href="#spectrocutoff">spectro-cutoff</a>
  <a href="#spectrohop">spectro-hop</a>
  <a href="#spectrostart">spectro-start</a>
  <a href="#spectroxangle">spectro-x-angle</a>
  <a href="#spectroxscale">spectro-x-scale</a>
  <a href="#spectroyangle">spectro-y-angle</a>
  <a href="#spectroyscale">spectro-y-scale</a>
  <a href="#spectrozangle">spectro-z-angle</a>
  <a href="#spectrozscale">spectro-z-scale</a>
  <a href="#sndtransformsample">transform-sample</a> (<i>bin slice snd chn</i>)
  <a href="#sndtransformsamples">transform-samples</a> (<i>snd chn</i>)
  <a href="#transformsamples2vct">transform-samples-&gt;vct</a> (<i>snd chn v</i>)
  <a href="#transformsize">transform-size</a> (<i>snd chn</i>)
  <a href="#ltransformtype">transform-type</a>
  <a href="#sndupdatefft">update-fft</a> (<i>snd chn</i>)
  <a href="#normalizefft">normalize-fft</a>
  <a href="#zeropad">zero-pad</a>
  <a href="#wavelettype">wavelet-type</a>
</pre>
<hr>

<h3><a name="snddialogs">Dialogs</a></h3>
<p>Many aspects of the various dialogs can be customized.  The following is organized by dialog.</p>

<pre>
  <a name="dismissalldialogs">dismiss-all-dialogs</a>   ()      deactivate all dialogs.

File:Open:
  <a name="justsounds">just-sounds</a>           #f      reflects the just-sounds button (if any)

View:Files:
  <a name="sndfiledialog">file-dialog</a>           ()      fire up the <a href="snd.html#prevfiles">list</a> of current and previous files (not the file browser).
  <a name="previousfilessort">previous-files-sort</a>   0       Sort choice in files dialog (0=unsorted, 1=name, etc).

Edit:Header:
  <a name="sndeditheaderdialog">edit-header-dialog</a>    ()      fire up Edit Header dialog.

Edit:envelope
  <a name="envedbase">enved-base</a>            1.0     <a href="snd.html#editenvelope">Envelope editor</a> exponential base value
  <a name="envedclipping">enved-clipping</a>        #f      <a href="snd.html#editenvelope">Envelope editor</a> 'clip' button (restricts mouse motion)
  <a name="enveddBing">enved-dBing</a>           #f      <a href="snd.html#editenvelope">Envelope editor</a> 'dB' button
  <a name="sndenveddialog">enved-dialog</a>          ()      fire up the Envelope editor dialog.
  <a name="envedexping">enved-exping</a>          #f      <a href="snd.html#editenvelope">Envelope editor</a> 'exp' and 'lin' buttons (type of connecting segments)
  <a name="envedpower">enved-power</a>           3.0     <a href="snd.html#editenvelope">Envelope editor</a> base scale range (9.0^power).
  <a name="envedtarget">enved-target</a>          <i>amplitude-env</i>
                                Determines how the envelope is applied to the current data
                                  This chooses one of the 'amp', 'flt', and 'src' buttons in the <a href="snd.html#editenvelope">Envelope editor</a>.
                                  The other (named constant) choices are <i>srate-env</i> and <i>spectrum-env</i>.
  <a name="envedwaveformcolor">enved-waveform-color</a>  blue    color of waveform displayed in envelope editor.
  <a name="envedwaving">enved-waving</a>          #f      <a href="snd.html#editenvelope">Envelope editor</a> 'wave' button
                                The wave shown is the time domain display, even when filtering.
  <a name="filterenvorder">filter-env-order</a>      40      The order of the Envelope editor's FIR filter.

Help:
  <a name="sndhelpdialog">help-dialog</a>           (subject help-string) 
                                fire up the help dialog with title <i>subject</i> and body <i>help</i>.
<small>
                                      (help-dialog "xyzzy" "are we having fun?")
</small>
  <a name="helptextfont">help-text-font</a>                help dialog text font
  <a name="htmldir">html-dir</a>                      If an HTML widget is in use, the directory to search for documentation.

View:Listener:
  <a name="activatelistener">activate-listener</a>     ()      make listener active, even if not open.
  <a name="sndhidelistener">hide-listener</a>         ()      close the lisp listener pane.
  <a name="listenercolor">listener-color</a>        aliceblue background color of lisp listener.
  <a name="listenerfont">listener-font</a>                 listener font.
  <a name="listenerprompt">listener-prompt</a>       "&gt;"     lisp listener prompt
  <a name="printlength">print-length</a>          12      number of elements of lists and vectors that are printed.
  <a name="sndshowlistener">show-listener</a>         ()      open the lisp listener pane.

View:Orientation:
  <a name="sndorientationdialog">orientation-dialog</a>    ()      fire up the <a href="snd.html#orientationbrowser">Orientation</a> dialog.
  <a href="#spectrocutoff">spectro-cutoff</a>        1.0     The amount of the frequency domain to include in the spectrum display.
                                  This number changes as you drag the frequency axis, for example.  
                                  This is the slider labelled '% of spectrum' in the View Orientation dialog.
  <a href="#spectrohop">spectro-hop</a>           4       The distance (pixels) moved between successive spectrogram traces.
                                  This is the slider labelled 'hop' in the Orientation dialog.
  <a href="#spectrostart">spectro-start</a>         0.0     The start point of the frequency domain to include in the spectrum display.
  <a href="#spectroxangle">spectro-x-angle</a>       90.0    Default spectrogram x-axis viewing angle.
  <a href="#spectroxscale">spectro-x-scale</a>       1.0     Default scaler (stretch) along the spectrogram x axis.
  <a href="#spectroyangle">spectro-y-angle</a>       0.0     Same for y-axis.
  <a href="#spectroyscale">spectro-y-scale</a>       1.0     Same for y-axis.
  <a href="#spectrozangle">spectro-z-angle</a>      -2.0     Same for z-axis
  <a href="#spectrozscale">spectro-z-scale</a>       0.1     Same for z-axis.

File:Record:
  <a name="recorderautoload">recorder-autoload</a>     #f      The '<a href="snd.html#Xautoload">autoload</a>' button in the recorder dialog.
  <a name="recorderbuffersize">recorder-buffer-size</a>  4096    The size of the recorder input buffer (there's a trade-off 
                                  between responsiveness and clicks in some cases).
  <a name="sndrecorderdialog">recorder-dialog</a>       ()      fire up <a href="snd.html#recordfile">recorder</a> window.
  <a name="recorderfile">recorder-file</a>         nil     Default recorder output file name.
  <a name="sndrecordergain">recorder-gain</a>         (gain)  recorder input (soundcard-audio) gain <i>gain</i>.
  <a name="sndrecorderinamp">recorder-in-amp</a>       (in out) recorder input channel <i>in</i> to output channel <i>out</i> amplitude.
  <a name="recorderinformat">recorder-in-format</a>    16-bit linear
                                Incoming data format for the recorder. 
  <a name="recordermaxduration">recorder-max-duration</a> 1000000.0  Recorder max output file length.
  <a name="sndrecorderoutamp">recorder-out-amp</a>      (out)   recorder file output channel <i>out</i> amplitude.
  <a name="recorderoutchans">recorder-out-chans</a>    2       Recorder output file channels.
  <a name="recorderoutformat">recorder-out-format</a>   same as <a href="#recorderinformat">recorder-in-format</a>
  <a name="recordersrate">recorder-srate</a>        22050   Recorder sampling rate.
  <a name="recordertrigger">recorder-trigger</a>      0.0     Recorder auto-trigger value.
  <a name="vufont">vu-font</a>               nil     The "vu-" variables refer to the VU meters in the recorder.
                                  <i>vu-font</i> is the font used to label the meters.  It is normally "courier".
  <a name="vufontsize">vu-font-size</a>          1.0     recorder VU meter label font size.
  <a name="vusize">vu-size</a>               1.0     overall size of the recorder VU meters.

View:Regions
  <a name="sndregiondialog">region-dialog</a>         ()      fire up <a href="snd.html#regionbrowser">region browser</a> (a no-op if no regions).

Options:Transforms (see <a href="#sndtransforms">Transforms</a>).
  <a name="sndtransformdialog">transform-dialog</a>      ()      fire up the Transform window (Option menu's Transform Options choice).

Error:
  <a name="sndyesornop">yes-or-no-p</a>           (ques)  modal error dialog, #t if user clicks "ok", otherwise #f.
</pre>

<p>The main menus can be extended, and new menus added with the following functions:</p>
<pre>
  <a name="sndaddtomainmenu">add-to-main-menu</a>      (menu-label)  
                                add new top-level menu named <i>menu-label</i>, return menu index.
<small>
                                      &gt;<em class=typing>(add-to-main-menu "Tools")</em>
                                      <em class=listener>5</em>
</small>
  <a name="sndaddtomenu">add-to-menu</a>           (top-menu menu-label callback) 
                                add menu <i>menu-label</i> to top-level menu whose index is 
                                <i>top-menu</i> with the callback function <i>callback</i>.  The built-in
                                Snd menus are numbered from 0 ('File') to 4 ('Help').  [<em class=error>no-such-menu</em>]
<small>
                                      (<em class=red>add-to-menu</em> 5 "Denoise" 
                                        (lambda () 
                                          (report-in-minibuffer "denoise")))
</small>
  <a name="sndchangemenulabel">change-menu-label</a>     (top-menu old-label new-label) 
  <a name="sndremovefrommenu">remove-from-menu</a>      (top-menu menu-label) 
                                remove menu <i>menu-label</i> from the top top-level menu whose index is <i>top-menu</i>.
  <a name="menusensitive">menu-sensitive</a>        (top-menu label)
</pre>
<hr>

<h3><a name="snderrors">Errors</a></h3>
<p> When something goes awry, the various functions can "throw" an error (a symbol)
which is normally "caught" by the default error handler (this is a kind of "goto" 
but without the embarassment); it prints out some message,
and in some cases appends a stack trace.  So, as a simple example, selection-beg
throws 'no-active-selection is there isn't a selection. In the default case, you
get behavior like this:
</p>
<pre>
&gt;<em class=typing>(selection-beg)</em>
<em class=listener>selection-beg: no-active-selection</em>
</pre>
<p>But there are cases where you'd rather handle an error (or all errors) specially.
In the case of 'no-active-selection, we set up our own handler for that as follows:</p>
<pre>
&gt;<em class=typing>(catch 'no-active-selection 
       (lambda () 
         (+ 1 (selection-beg))) 
       (lambda (tag val) 0))</em>
<em class=listener>0</em>
</pre>
<p>Here's we've "caught" 'no-active-selection (if it occurs within the
first "thunk's" body), and return 0 if it occurs; otherwise we return
<code>(+ 1 (selection-beg))</code>.  Scheme (Guile) has a number
of errors such as 'out-of-range, 'wrong-type-arg, 'numerical-overflow,
etc.  The Snd-specific errors are:</p>
<pre>
'no-such-channel 'no-such-sound  'no-such-mark       'no-such-mix
'no-such-menu    'no-such-file   'no-such-region     'no-such-sample
'no-such-edit    'cannot-save    'impossible-bounds  'no-active-selection
'no-such-widget  'mus-error      'no-such-track
</pre>
<p>The symbol #t stands for all errors in this case, so we can 
run rough-shod over any error with:</p>
<pre>
(defmacro without-errors (func)
  `(catch #t 
	  (lambda ()
	    ,func)
	  (lambda args (car args))))
</pre>
<p>You can use these errors in your code, if you like.  The following
throws the error 'no-such-file:</p>
<pre>
(define look-for-file
  (lambda (file)
    (or (file-exists? file)
	(throw 'no-such-file (list "look-for-file" file)))))
</pre>
<hr>


<h3><a name="sndconstants">Constants</a></h3>

<pre>

Sndlib (see <a href="sndlib.html#sndlibguile">sndlib.html</a> for a complete list):
  <a name="nextsoundfile">mus-next</a> mus-aifc mus-riff mus-nist mus-raw mus-ircam mus-aiff

  <a name="snd16linear">mus-bshort</a>  mus-lshort mus-mulaw  mus-alaw   mus-byte   mus-ubyte   mus-bfloat
  mus-lfloat  mus-bint   mus-lint   mus-b24int mus-l24int mus-bdouble mus-ldouble
  mus-ubshort mus-ulshort

FFT style (the Transform Options Display choice):
  normal-fft         sonogram            spectrogram

Transform type: 
  <a name="fouriertransform">fourier-transform</a>  wavelet-transform   hankel-transform    chebyshev-transform
  autocorrelation    walsh-transform     hadamard-transform  cepstrum

Transform normalization choice:
  dont-normalize    normalize-by-channel normalize-by-sound  normalize-globally

<a name="fftwindowchoices"></a>FFT Window type:
  rectangular-window hanning-window     welch-window      parzen-window
  bartlett-window    hamming-window     blackman2-window  blackman3-window
  blackman4-window   exponential-window riemann-window    kaiser-window
  cauchy-window      poisson-window     gaussian-window   tukey-window

Zoom Focus style:
  focus-left         focus-right        focus-active      focus-middle

X-axis Label:
  x-in-seconds       x-in-samples       x-to-one

Speed Control style:
  speed-as-float     speed-as-ratio     speed-as-semitone

Channel Combination style;
  <a name="channelstyleconstants">channels-separate</a>  channels-combined  channels-superimposed

Envelope Editor target:
  amplitude-env      spectrum-env       srate-env

Graph Line style:
  <a name="graphlines">graph-lines</a>        graph-dots         graph-filled      graph-lollipops
  graph-dots-and-lines 

Keyboard action choices:
  <a name="cursorchoices">cursor-in-view</a>     cursor-on-left     cursor-on-right   cursor-in-middle 
  cursor-update-display cursor-no-action cursor-claim-selection keyboard-no-action

Cursor style:
  cursor-cross   cursor-line

Axis choice:
  show-all-axes  show-no-axes  show-x-axis

</pre>
<hr>



<h3><a name="sndmisc">Miscellaneous functions</a></h3>

<p>These functions don't seem to fit anywhere else:</p>
<pre>
  <a name="sndclearaudioinputs">clear-audio-inputs</a>()            in Linux/OSS, try to reduce soundcard background racket.
  <a name="sndclosesoundfile">close-sound-file</a>  (fd bytes)    close file updating header to report <i>bytes</i> bytes of data.
  <a name="sndopensoundfile">open-sound-file</a>   (<i>name chans srate comment</i>)        
                                  Open (create) a sound file <i>name</i> (defaults to "test.snd" or "test.wav").  
                                  It is assumed that the data will be floats in the native format (written by 
                                  the caller interleaving channels), and that the file will be closed by 
                                  close-sound-file. One simple way to write the data is to call 
                                  <a href="#vct2soundfile">vct-&gt;sound-file</a>.
  <a name="abort">abort</a>             ()            drop into gdb
  <a name="sndabort">abort?</a>            ()            check for C-g to interrupt on-going computation (and let other UI 
                                  events through).
  <a name="addsoundfileextension">add-sound-file-extension</a> (ext)  add <i>ext</i> to the list of sound file extensions.
                                  The initial list is ("snd" "aiff" "aif" "wav" "au" "aifc" "voc" "wve")
  <a name="sndautocorrelate">autocorrelate</a>     (data)        return (in place) autocorrelation of <i>data</i>
  <a name="sndbindkey">bind-key</a>          (key state func <i>ignore-prefix</i>) 
                                  Cause <i>key</i> (an integer) with modifiers <i>state</i> to evaluate <i>code</i>.
<small>
                                      (bind-key (char-&gt;integer #\a) 4 (lambda () (snd-print \"hi\")))

                                  The modifier state is a combination of shift: 1, control: 4, meta: 8, 
                                  so this call causes C-a to print "hi" in the lisp listener.  The 
                                  value returned should be one of the cursor choices (see below) telling Snd what 
                                  action (if any) to take after evaluating <i>code</i>.  If <i>ignore-prefix</i> is 
                                  #t, Snd does not repeat the key based on the prefix argument (<a href="snd.html#kcu">C-u</a>) --
                                  in this case, the <i>code</i> can examine <a href="#prefixarg">prefix-arg</a> if desired.
                                  Possible return values are:

                                  cursor-in-view     cursor-on-left     cursor-on-right   cursor-in-middle 
                                  cursor-update-display cursor-no-action cursor-claim-selection keyboard-no-action
</small>
  <a name="sndconvolve">convolve-arrays</a>   (rl1 rl2)     convolve vectors <i>rl1</i> with <i>rl2</i>.  Result returned in rl1.
                                  rl1 should be large enough to hold the full convolution result.
                                  As a special dispensation for forgetful users, if rl1 is a file
                                  name and rl2 is not a vector, <i>convolve-with</i> is called instead.
  <a name="lcountmatches">count-matches</a>     (expr <i>sample snd chn</i>) 
                                  return how many samples satisfy the expression <i>expr</i>.  <i>expr</i>
                                  is a Scheme function of one argument (the current sample value). <i>sample</i> 
                                  determines where to start the search.

                                     (count-matches (lambda (y) (&gt; y .1)))

  <a name="sndexit">exit</a>              ()            exit Snd.
  <a name="sndfft">fft</a>               (rl im <i>sgn</i>)   perform an FFT on <i>rl</i> and <i>im</i> (the real and imaginary parts of the
                                  input data. <i>sgn</i> is 1 for an FFT, -1 for an inverse FFT; (default 1).
  <a name="lfind">find</a>              (expr <i>sample snd chn</i>) 
                                  find the sample that satisfies the Scheme function <i>expr</i>. <i>sample</i>
                                  determines where to start the search. 

                                     (find (lambda (y) (&gt; y .1)))

  <a name="sndgraph2ps">graph-&gt;ps</a>         ()            create Postscript description of current display (see <a href="#epsfile">eps-file</a>).
  <a name="gin">in</a>                (ms thunk)    <i>ms</i> milliseconds from now, evaluate <i>thunk</i>, a function of no arguments.
  <a name="sndkey">key</a>               (key state <i>snd chn</i>) 
                                  execute the keyboard command <i>key</i> with modifier keys <i>state</i>.
                                  shift: 1, control: 4, meta: 8
  <a name="sndnormalizeview">normalize-view</a>    ()            normalize Snd display as in View menu <a href="snd.html#viewnormalize">Normalize</a> option.
  <a name="sndpreloaddirectory">preload-directory</a> (dir)         preload sound files from directory <i>dir</i> (see -<a href="snd.html#minusp">p</a>).
  <a name="sndpreloadfile">preload-file</a>      (file)        preload <i>file</i> (see View menu's <a href="snd.html#prevfiles">View Files</a> option).
  <a name="sndsaveenvelopes">save-envelopes</a>    (filename)    save envelope editor contents in <i>filename</i> [<em class=error>cannot-save</em>].
  <a name="sndsavemacros">save-macros</a>       ()            save <a href="snd.html#kbdmacros">keyboard macros</a> in Snd's init file (~/.snd).
  <a name="sndsaveoptions">save-options</a>      (filename)    save options in <i>filename</i> [<em class=error>cannot-save</em>].
  <a name="sndsavestate">save-state</a>        (filename)    save current state of Snd in <i>filename</i>.
  <a name="sndapropos">snd-apropos</a>       (name)        return possible completions of <i>name</i> (a string or a symbol).
  <a name="snderror">snd-error</a>         (str)         report error message <i>str</i>, return <i>str</i>.
  <a name="sndhelp">snd-help</a>          (obj)         returns (as a string) the help text associated with <i>obj</i>,
                                  for example: (snd-help vct-ref).
<small>
                                  For scheme functions, this returns the procedure-documentation, if any.  To go to the
                                  HTML documentation for a given procedure, load index.scm and use the html function.
                                  To get a more global help function, (use-modules (ice-9 session)).  This loads Guile's
                                  help (and apropos) support which uses 'regexps' and so forth.
</small>
  <a name="sndprint">snd-print</a>         (str)         display <i>str</i> in lisp listener, return <i>str</i>.  (This is intended as a
                                  debugging aid -- there's still nothing like a lowly print statement).
  <a name="sndspectrum">snd-spectrum</a>      (data window length <i>linear</i>)
                                  return spectrum of <i>data</i> (type vct) using fft-window <i>win</i>.
                                  length of data (and fft) is <i>length</i>.
  <a name="sndtempnam">snd-tempnam</a>       ()            New temp file name using Snd's <a href="#tempdir">temp-dir</a>.
  <a name="sndversion">snd-version</a>       ()            Snd version (a string).
  <a name="sndwarning">snd-warning</a>       (str)         report warning message <i>str</i>, return <i>str</i>.
  <a name="soundfilesindirectory">sound-files-in-directory</a> (dir)  return a vector of sound file names.
<small>
                                  This is useful for "batch" processing of sounds.  The following,
                                  for example, prints the names of all the stereo AIFC files it finds:

                                     (let ((files (<em class=red>sound-files-in-directory</em> ".")))
                                       (do ((i 0 (1+ i)))
                                           ((= i (vector-length files)))
                                         (let ((filename (vector-ref files i)))
                                           (if (and (= (mus-sound-header-type filename) mus-aifc)
                                                       (= (mus-sound-chans filename) 2))
                                               (snd-print filename)))))

                                  See also map-sound-files in examp.scm.
</small>
  <a name="sndunbindkey">unbind-key</a>  (key state) cause <i>key</i> with modifiers <i>state</i> to be a no-op.

  <a name="ldefvar">defvar</a>            (var val)     same as (define var val) except that the envelope editor keeps track
                                  of <i>var</i> thereafter and treats lists as envelopes. (<i>defvar</i> is a macro).
<small>
                                  I'm using <i>defvar</i> here rather than some more perspicuous name like def-envelope
                                  so that Snd and CLM can share envelope files.
</small>
</pre>
<hr>


<h3><a name="sndexamples">Examples</a></h3>

<p>These examples are simplified to make the exposition cleaner; see examp.scm for more robust versions.
examp.scm also has examples that add and remove menu items, set variables via the special "F" keys,
perform correlation on the current data, 
make a system call from the listener, and so on.  The following function computes the rms amplitude of a region:</p>
<pre>
(define region-rms
 (lambda (n)
  (let* ((data (<a href="#sndregionsamples">region-samples</a> 0 0 n))
	 (len (vector-length data))
	 (sum 0.0))
   (do ((i 0 (1+ i))) ((= i len) (sqrt (/ sum len))) 
    (set! sum (+ sum (* (vector-ref data i) (vector-ref data i))))))))
</pre>
<p>To get the data currently displayed in the time domain window:</p>
<pre>
(define <a name="windowsamples">window-samples</a>
 (lambda ()
  (let ((wl (<a href="#sndleftsample">left-sample</a>))
	(wr (<a href="#sndrightsample">right-sample</a>)))
   (<a href="#sndsamples">samples</a> wl (+ 1 (- wr wl))))))
</pre>
<p>Now we can use <i>window-samples</i> and <i>graph-hook</i>
to show a running graph of the
time domain energy:</p>
<pre>
(define <a name="displayenergy">displaye-nergy</a>
 (lambda ()
  (let* ((data (window-samples))
	 (len (vector-length data)))
   (do ((i 0 (1+ i))) ((= i len))
    (vector-set! data i (* (vector-ref data i) (vector-ref data i))))
   (<a href="#sndgraph">graph</a> data))))

(set! <a href="#graphhook">graph-hook</a> display-energy)
</pre>
<p>As the time domain window is moved, the lisp window automatically
updates itself.  The same thing can show the spectral energy
(via <i>transform-samples</i>).  
The functions graph, fft, insert-samples, and set-samples know about vcts,
so we can rewrite display-energy:</p>
<pre>
(define display-energy
  (lambda (snd chn y0 y1)
    (let* ((ls (left-sample snd chn))
	   (rs (right-sample snd chn))
	   (data (samples-&gt;vct ls (+ 1 (- rs ls)) snd chn))
	   (len (vct-length data))
	   (sr (srate snd)))
      (vct-multiply! data data)
      (graph data "energy" (/ ls sr) (/ rs sr) 0.0 (* y1 y1) snd chn))))
</pre>

<p>See examp.scm for more examples of using the vct structure.
Say we want Snd to refuse to exit if there are unsaved edits.</p>
<pre>
(define <a name="unsavededits">unsaved-edits?</a>
  (lambda (ind)
    (and (&lt; ind (max-sounds))
	 (or (and (sound? ind)
		  (&gt; (car (edits ind)) 0)
		  (report-in-minibuffer "there are unsaved edits")
		  #t)
	     (unsaved-edits? (+ ind 1))))))

(add-hook! exit-hook (lambda () (report-in-minibuffer "") (unsaved-edits? 0)))
</pre>

<p>Here's somewhat brute-force code to play a sound a given number of times:</p>
<pre>
(define plays 0)

(define pl1
  (lambda (snd)
    (if (= plays 0)
	(remove-hook! stop-playing-hook pl1)
      (begin
	(set! plays (- plays 1))
	(play 0 snd)))))

(define (pl n) 
  (set! plays (- n 1))
  (add-hook! stop-playing-hook pl1)
  (play))

(bind-key (char-&gt;integer #\p) 0 (lambda () (pl (max 1 (prefix-arg)))) #t)
</pre>

<p>Say we are so annoyed by the X/Motif file browser that we want
Snd to exit back to the shell if its file argument is not
found (this code obviously has to be in the init file):</p>
<pre>
(define no-startup-file?
  (lambda (ind file)
    (if (= ind (max-sounds))
	(begin
	  (write (string-append "can't open " file) (current-error-port))
	  (newline (current-error-port))
	  #t)
	(if (sound? ind)
	    #f
	    (no-startup-file? (+ ind 1) file)))))

(add-hook! start-hook (lambda (file) (if (&gt; (string-length file) 0) (no-startup-file? 0 file) #f)))
</pre>
<p>And just for completeness, here's an example of using the fft-hook.
</p>
<pre>
(define fft-peak
  (lambda (snd chn scale)
    (if (and (ffting) (= (fft-style) normal-fft))
	(let* ((samps (transform-samples snd chn))
	       (len (vector-length samps))
	       (mx (vector-ref samps 0))
	       (peak (do ((i 1 (+ i 1))) ((= i len) (/ (* 2 mx) (fft-size)))
		       (let ((val (abs (vector-ref samps i))))
			 (if (&gt; val mx) (set! mx val))))))
	  (report-in-minibuffer (number-&gt;string peak) snd))
      #f)))
	
(add-hook! fft-hook fft-peak)
</pre>
<p>The following function uses the sndlib functions to mimic the 'info' popup menu option (see examp.scm for a version that uses format):</p>
<pre>
<a name="sndinfo"></a>
(define info 
  (lambda (file)
    (string-append 
     file
     ": chans: " (number-&gt;string (<a href="#soundchans">mus-sound-chans</a> file))
     ", srate: " (number-&gt;string (<a href="#soundsrate">mus-sound-srate</a> file))
     ", " (<a href="#soundtypename">mus-header-type-name</a> (<a href="#soundheadertype">mus-sound-header-type</a> file))
     ", " (<a href="#soundformatname">mus-data-format-name</a> (<a href="#sounddataformat">mus-sound-data-format</a> file))
     ", len: " (number-&gt;string 
                (/ (<a href="#soundsamples">mus-sound-samples</a> file) 
                   (* (<a href="#soundchans">mus-sound-chans</a> file) (<a href="#soundsrate">mus-sound-srate</a> file)))))))
</pre>

<img src="energy.png" alt="picture of examp.scm in action">
<br><br>

        <!-- I(open file):L(open-sound)(sndopen) -->
	<!-- I(close file):L(close-sound)(sndclose) -->
	<!-- I(save file):L(save-sound)(sndsave) -->
        <!-- I(save file as):L(save-sound-as)(sndsaveas) -->
        <!-- I(change format):L(save-sound-as)(sndsaveas) -->
	<!-- I(revert file):L(revert-sound)(sndrevert) -->
        <!-- I(open file read-only):L(view-sound)(sndview) -->
        <!-- I(create new file):L(new-sound)(sndnew) -->
	<!-- I(print file):L(graph->ps)(sndgraph2ps) -->
	<!-- I(exit Snd):L(exit)(sndexit) -->
        <!-- I(undo edit):L(undo)(sndundo) -->
	<!-- I(redo edit):L(redo)(sndredo) -->
        <!-- I(cut selection):L(cut)(sndcut) -->
	<!-- I(insert selection):L(insert-region)(sndinsertregion) -->
	<!-- I(play file):L(play, stop)(sndplay) -->
        <!-- I(show marks):L(show-marks)(showmarks) -->
	<!-- I(y=0 line):L(show-y-zero)(showyzero) -->
	<!-- I(dots or lines):L(graph-style)(graphstyle) -->
        <!-- I(combine channels):L(channel-style)(channelstyle) -->
        <!-- I(normalize display):L(normalize-view)(sndnormalizeview) -->
        <!-- I(control panel):L(showing-controls)(sndshowingcontrols) -->
	<!-- I(fft peaks):L(show-fft-peaks)(showfftpeaks) -->
        <!-- I(fft peaks):O(peaks)(sndpeaks) -->
	<!-- I(fft/sono/spectrogram):L(fft-style)(lfftstyle) -->
        <!-- I(zoom focus):L(zoom-focus-style)(zoomfocusstyle) -->
	<!-- I(fft in dB):L(fft-log-magnitude)(fftlogmagnitude) -->
	<!-- I(fft log freq):L(fft-log-frequency)(fftlogfrequency) -->
	<!-- I(axis fits data):L(fit-data-on-open)(fitdataonopen) --><!-- I(axis fits data):O(y-bounds)(sndybounds) -->
        <!-- I(axis fits data):A(fitdataonopen) -->
	<!-- I(select sound):L(select-sound)(sndselectsound) -->
	<!-- I(multichannel ops):L(syncing)(sndsyncing) -->
        <!-- I(save control panel):L(control-panel-save)(sndcontrolpanelsave) -->
	<!-- I(amp env):L(env-sound)(sndenv) -->
        <!-- I(filter):L(filter-env)(sndfilterenv) -->
	<!-- I(filter):M(Edit: Edit Env)(editenvelope) -->
        <!-- I(axis bounds):L([xy]-bounds)(sndxbounds) -->
	<!-- I(max amp):L(maxamp)(sndmaxamp) -->
	<!-- I(max amp):A(sndmaxamp) -->
        <!-- I(define mark):L(add-mark)(sndaddmark) -->
	<!-- I(preload directory):L(preload-directory)(sndpreloaddirectory) -->
        <!-- I(color):L(color-dialog)(sndcolordialog) -->
	<!-- I(color):O(color-scale,color-cutoff)(colorscale) -->
        <!-- I(orientation):L(orientation-dialog)(sndorientationdialog) -->
	<!-- I(file lists):L(file-dialog)(sndfiledialog) -->
        <!-- I(define selection):L(make-region)(sndmakeregion) -->
	<!-- I(delete samples):L(delete-samples)(snddeletesamples) -->
        <!-- I(temp directory):L(temp-dir)(tempdir) -->
        <!-- I(continue session):L(load) -->
        <!-- I(fft window):L(fft-window)(lfftwindow) -->
	<!-- I(fft size):L(fft-size)(lfftsize) -->
        <!-- I(fft window parameter):L(fft-beta)(fftbeta) -->
	<!-- I(move cursor ahead):L(forward-sample)(sndforwardsample) -->
        <!-- I(move cursor back):L(backward-sample)(sndbackwardsample) -->
	<!-- I(file formats):L(raw-format)(rawformat) -->
        <!-- I(insert zeros):L(insert-samples)(sndinsertsamples) -->
	<!-- I(change samples):L(set-samples)(sndsetsamples) -->
	<!-- I(srate conversion):L(src-sound)(sndsrc) --><!-- I(srate conversion):M(Edit: Edit Env)(editenvelope) -->
        <!-- I(srate conversion):O(src-selection)(sndsrcselection) --><!-- I(srate conversion):A(sndsrc) -->
	<!-- I(resample):L(src-sound)(sndsrc) --><!-- I(resample):M(Edit: Edit Env)(editenvelope) --><!-- I(resample):A(sndsrc) -->
	<!-- I(resample):O(src-selection)(sndsrcselection) --><!-- I(reverse samples):A(sndreverse) -->
	<!-- I(reverse samples):L(reverse-sound)(sndreverse) --><!-- I(reverse samples):O(reverse-selection)(sndreverseselection) -->
	<!-- I(filter samples):L(filter-sound)(sndfilter) --><!-- I(filter samples):M(Edit: Edit Env)(editenvelope) -->
	<!-- I(filter samples):O(filter-selection)(sndfilterselection) --><!-- I(filter samples):A(sndfilter) -->
	<!-- I(save marks):L(save-marks)(sndsavemarks) -->
        <!-- I(show freq domain):L(ffting)(sndffting) -->
	<!-- I(show time domain):L(waving)(sndwaving) -->
        <!-- I(keyboard macros):L(key)(sndkey) -->
        <!-- I(delete mark):L(delete-mark)(snddeletemark) --> <!-- I(delete mark):O(delete-marks)(snddeletemarks) -->
	<!-- I(sonogram):L(fft-style)(lfftstyle) -->
	<!-- I(spectrogram):L(fft-style)(lfftstyle) -->
        <!-- I(X axis units):L(x-axis-style)(xaxisstyle) -->
	<!-- I(speed units):L(speed-style)(lspeedstyle) -->
        <!-- I(fft normalization):L(normalize-fft)(normalizefft) -->
        <!-- I(fft normalization):A(normalizefft) -->
	<!-- I(speed units):O(speed-tones)(speedtones) -->
	<!-- I(change srate):L(src-sound)(sndsrc) -->	
	<!-- I(edit env):L(enved-dialog)(sndenveddialog) -->
	<!-- I(edit header):L(edit-header-dialog)(sndeditheaderdialog) -->
	<!-- I(insert file):L(insert-sound)(sndinsertfile) -->
	<!-- I(mix file):L(mix)(sndmix) -->
	<!-- I(move mixed file):L(mix-position)(sndmixposition) -->
	<!-- I(move to mark):L(forward-mark)(sndforwardmark) -->
	<!-- I(move to mix):L(forward-mix)(sndforwardmix) -->
	<!-- I(play selection):L(play-region)(sndplayregion) -->
	<!-- I(update file):L(update)(sndupdate) -->
	<!-- I(view envs):L(enved-dialog)(sndenveddialog) -->
	<!-- I(play channel):L(play)(sndplay) -->
	<!-- I(mix selection):L(mix-region)(sndmixregion) -->
	<!-- I(interrupt Snd):L(stop)(sndstop) -->
	<!-- I(move window back):L(left-sample)(sndleftsample) -->
	<!-- I(move window ahead):L(right-sample)(sndrightsample) -->
	<!-- I(numeric arguments):L(prefix-arg)(prefixarg) -->
	<!-- I(change tempo):L(expand)(sndexpand) -->
	<!-- I(wavelets):L(wavelet-type)(wavelettype) -->
	<!-- I(save macros):L(save-macros)(sndsavemacros) -->
        <!-- I(save selection):L(save-region)(sndsaveregion) --><!-- I(save selection):O(save-selection)(sndsaveselection) -->
	<!-- I(examine regions):L(region-dialog)(sndregiondialog) -->
	<!-- I(zoom window):L(x-bounds)(sndxbounds) -->
	<!-- I(save options):L(save-options)(sndsaveoptions) -->
	<!-- I(describe audio):A(describeaudiostate) --><!-- I(describe audio):L(mus-audio-describe)(describeaudiostate) -->
	<!-- I(abort command):L(abort?)(sndabort) -->
	<!-- I(count matches):L(count-matches)(lcountmatches) --><!-- I(count matches):A(lcountmatches) -->
	<!-- I(convolution):L(convolve)(sndconvolve) --><!-- I(convolution):A(sndconvolve) --><!-- I(convolution):O(convolve-with)(sndconvolvewith) -->
	<!-- I(auto-save):O(examp.scm) -->
        <!-- I(reverberate file):L(convolve-with)(sndconvolvewith) -->
        <!-- I(record sound):L(recorder-dialog)(sndrecorderdialog) -->
        <!-- I(describe file):L(info)(sndinfo) -->
        <!-- I(change pitch):L(src-sound)(sndsrc) -->
	<!-- I(change colors):L(make-color)(aboutcolors) --><!-- I(change colors):A(aboutcolors) --><!-- I(change colors):O(resources)(sndresources) -->
	<!-- I(create new file):O(default-output-srate)(defaultoutputsrate) -->
	<!-- I(autocorrelation):L(autocorrelate)(sndautocorrelate) -->

<center><small><a href="snd.html#overview">snd.html</a>    <a href="grfsnd.html#grfsndcontents">grfsnd.html</a>    <a href="clm.html#introduction">clm.html</a>    <a href="sndlib.html#introduction">sndlib.html</a></small></center>

</body></html>
